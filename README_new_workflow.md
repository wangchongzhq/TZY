# 电视直播线路自动更新工作流 - 使用说明文档

## 📋 项目简介

本项目提供一个基于GitHub Actions的电视直播线路自动更新工作流，通过GitHub API直接更新文件，完全避免了git push操作带来的版本冲突问题。该工作流能够自动运行电视直播线路收集脚本，并将更新后的文件上传到GitHub仓库，实现完全自动化的维护。

## 🌟 工作流优势

- **无git push冲突**: 使用GitHub API直接更新文件，彻底解决了`cannot lock ref`错误
- **智能重试机制**: 内置指数退避重试策略，应对网络波动和API限流
- **完善的错误处理**: 全面的错误检测和报告机制，提高稳定性
- **版本冲突处理**: 自动检测和解决文件版本冲突
- **详细日志**: 提供完整的执行日志，便于调试和监控

## 🚀 快速部署指南

### 1. 准备工作

确保您的仓库中包含以下文件：
- `tvzydaily.py` - 电视直播线路收集脚本
- `.github/workflows/tvzydaily-update.yml` - 工作流配置文件（将在下文创建）

### 2. 部署工作流

1. **创建工作流文件**：
   - 在您的GitHub仓库中，导航至 `.github/workflows/` 目录
   - 创建或替换 `tvzydaily-update.yml` 文件，复制本项目中的工作流配置

2. **启用工作流**：
   - 进入GitHub仓库的 **Actions** 页面
   - 点击 **启用工作流**
   - 选择 `电视直播线路自动更新工作流`
   - 点击 **Run workflow** 手动触发第一次运行

### 3. 验证部署

- 工作流运行完成后，检查仓库中是否成功生成/更新了 `tzydauto.txt` 文件
- 查看工作流运行日志，确认是否有错误信息

## ⚙️ 工作流配置详解

### 定时执行

工作流默认设置为每天早上8点自动运行：
```yaml
on:
  schedule:
    - cron: '0 8 * * *'  # 每天早上8点运行
  workflow_dispatch:  # 允许手动触发
```

您可以修改cron表达式来自定义运行时间：
- 格式: `分 时 日 月 周`
- 示例: `0 1 * * *` 表示每天凌晨1点运行

### 环境变量

工作流使用以下关键环境变量：

- `GITHUB_TOKEN`: 自动提供的GitHub认证令牌
- `REPO_OWNER`: 当前仓库所有者
- `REPO_NAME`: 当前仓库名称
- `BRANCH`: 默认使用 `main` 分支
- `GITHUB_API_VERSION`: 使用的GitHub API版本

**注意**：无需手动设置这些环境变量，GitHub Actions会自动提供。

## 📊 输出文件

工作流成功运行后会生成/更新以下文件：

- `tzydauto.txt`: 主要的电视直播线路输出文件
- `debug_output.txt`: 调试日志（如果存在）
- `tvzy.log`: 脚本运行日志（如果存在）

## 🔍 常见问题排查

### 1. API调用失败

**症状**：工作流运行失败，日志显示API请求错误

**解决方法**：
- 检查GitHub Actions的服务状态
- 确认仓库的Actions权限设置正确
- 查看详细错误信息，根据HTTP状态码排查

### 2. 文件上传失败

**症状**：工作流运行但文件未更新

**解决方法**：
- 检查输出文件是否生成且不为空
- 验证文件路径是否正确
- 查看API响应中的错误信息

### 3. 权限问题

**症状**：日志显示401或403错误

**解决方法**：
- 确认仓库的Actions权限设置
- 对于私有仓库，确保GITHUB_TOKEN有足够权限

## 📁 工作流程

1. **检出代码**：拉取最新代码到运行环境
2. **环境准备**：设置Python环境并安装依赖
3. **执行脚本**：运行tvzydaily.py收集电视直播线路
4. **文件上传**：使用GitHub API上传更新后的文件
5. **状态通知**：输出成功或失败的状态信息

## 📝 注意事项

- 确保tvzydaily.py脚本能够正常生成tzydauto.txt文件
- 工作流使用默认的GITHUB_TOKEN权限，无需额外配置
- 对于大型文件，API上传可能需要更长时间，请耐心等待
- 如遇到API限流，可以增加重试延迟时间

## 🆘 技术支持

如遇到无法解决的问题，请参考以下步骤：

1. 检查完整的工作流运行日志
2. 根据错误信息搜索解决方案
3. 确保所有配置文件格式正确
4. 尝试手动运行脚本验证其功能

---

**免责声明**：本工具仅用于技术研究和学习目的，请勿用于商业用途。使用本工具获取的播放源时，请确保您已获得合法授权。
