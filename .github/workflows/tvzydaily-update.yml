name: TVZY Daily Update

on:
  # æ¯å¤©å®šæ—¶è¿è¡Œ
  schedule:
    - cron: '0 0 * * *'  # æ¯å¤©UTC 0ç‚¹è¿è¡Œ
  # å…è®¸æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      logLevel:
        description: 'Log level'
        required: true
        default: 'info'

jobs:
  update-tv-channels:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # ç¡®ä¿æœ‰å†™æƒé™
    steps:
      # ç¬¬ä¸€æ­¥ï¼šä½¿ç”¨ç‰¹å®šçš„tokenå‚æ•°é‡æ–°æ£€å‡ºä»£ç 
      - name: Checkout repository with write access
        uses: actions/checkout@v3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          ref: main
          fetch-depth: 0
          persist-credentials: true
      
      # ç¬¬äºŒæ­¥ï¼šè®¾ç½®Pythonç¯å¢ƒ
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
      
      # ç¬¬ä¸‰æ­¥ï¼šå®‰è£…ä¾èµ–
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests schedule
      
      # ç¬¬å››æ­¥ï¼šç”Ÿæˆæ–‡ä»¶å¹¶æ¨é€ï¼ˆä½¿ç”¨ç®€åŒ–ä½†æ›´å¯é çš„æ–¹æ³•ï¼‰
      - name: Generate and upload file
        run: |
          echo "ğŸ”„ å¼€å§‹ç”Ÿæˆç›´æ’­æºæ–‡ä»¶..."
          
          # è¿è¡Œè„šæœ¬ç”Ÿæˆæ–‡ä»¶
          python tvzydaily.py
          
          # éªŒè¯æ–‡ä»¶ç”Ÿæˆ
          if [ ! -f "tzydauto.txt" ]; then
            echo "âŒ é”™è¯¯: tzydauto.txt æ–‡ä»¶æœªç”Ÿæˆ"
            exit 1
          fi
          
          echo "âœ… æ–‡ä»¶ç”ŸæˆæˆåŠŸï¼Œå†…å®¹ç»Ÿè®¡ï¼š"
          wc -l tzydauto.txt
          
          # ä½¿ç”¨GitHub CLIä½œä¸ºæ›´å¯é çš„æ¨é€æ–¹å¼
          echo "ğŸ”„ å®‰è£…GitHub CLI..."
          sudo apt-get update
          sudo apt-get install -y gh
          
          # é…ç½®GitHub CLI
          echo "ğŸ”„ é…ç½®GitHub CLI..."
          echo "${{ secrets.GITHUB_TOKEN }}" | gh auth login --with-token
          gh auth status
          
          # ä½¿ç”¨GitHub CLIæ›´æ–°æ–‡ä»¶ - è¿™æ˜¯æœ€å¯é çš„æ–¹å¼ï¼Œæ— éœ€å¤„ç†gitåˆå¹¶
          echo "ğŸ”„ ä½¿ç”¨GitHub CLIæ›´æ–°æ–‡ä»¶..."
          if gh api -X PUT /repos/wangchongzhq/zhby/contents/tzydauto.txt \
             -F message="Auto-update IPTV files - $(date +'%Y-%m-%d %H:%M:%S')" \
             -F content="$(base64 tzydauto.txt)" \
             -F branch=main; then
            echo "âœ… âœ… âœ… æˆåŠŸä½¿ç”¨GitHub APIæ›´æ–°æ–‡ä»¶ï¼"
          else
            echo "âŒ GitHub APIæ›´æ–°å¤±è´¥ï¼Œå°è¯•å¤‡ç”¨æ–¹æ³•..."
            
            # å¤‡ç”¨æ–¹æ³•ï¼šä½¿ç”¨ä½çº§åˆ«API
            CONTENT=$(base64 -w 0 tzydauto.txt)
            curl -X PUT \
                 -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
                 -H "Accept: application/vnd.github+json" \
                 https://api.github.com/repos/wangchongzhq/zhby/contents/tzydauto.txt \
                 -d '{"message":"Auto-update IPTV files - $(date +'%Y-%m-%d %H:%M:%S')","content":"'"$CONTENT"'","branch":"main"}'
            
            if [ $? -eq 0 ]; then
              echo "âœ… å¤‡ç”¨æ–¹æ³•æˆåŠŸï¼"
            else
              echo "âŒ æ‰€æœ‰æ–¹æ³•éƒ½å¤±è´¥äº†"
              exit 1
            fi
          fi
          
          echo "ğŸ‰ æ›´æ–°å®Œæˆï¼"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
