name: TVZY Daily Update

on:
  # æ¯å¤©å®šæ—¶è¿è¡Œ
  schedule:
    - cron: '0 1 * * *'  # æ¯å¤©1:00 UTCè¿è¡Œï¼ˆåŒ—äº¬æ—¶é—´9:00ï¼‰
  # å…è®¸æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      logLevel:
        description: 'Log level'
        required: true
        default: 'info'

jobs:
  update-tv-channels:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0  # è·å–å®Œæ•´å†å²
          persist-credentials: false  # ç¦ç”¨é»˜è®¤å‡­æ®å­˜å‚¨
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
          
      - name: Install dependencies with verbose logging
        run: |
          python --version
          python -m pip --version
          python -m pip install --upgrade pip
          pip install requests schedule
          pip list
          
      - name: Debug environment
        run: |
          echo "Current directory: $(pwd)"
          echo "Directory contents:"
          ls -la
          echo "Python path: $(which python)"
          echo "Python env:"
          python -c "import sys; print(sys.path)"
      
      - name: Create test output directory if needed
        run: mkdir -p output
        
      - name: Run TVZY update script with debug
        id: run_script
        run: |
          echo "Starting TVZY update script..."
          python -u tvzydaily.py 2>&1 | tee script_output.log
          EXIT_CODE=${PIPESTATUS[0]}
          echo "Script exit code: $EXIT_CODE"
          echo "script_exit_code=$EXIT_CODE" >> $GITHUB_ENV
          
      - name: Check script output and logs
        run: |
          echo "=== Script output log ==="
          cat script_output.log || echo "No script output log found"
          
          echo "=== Python errors ==="
          grep -i "error\|exception\|fail" script_output.log || echo "No obvious errors found"
          
          echo "=== Current directory after script ==="
          ls -la
          
      - name: Check if output file exists
        id: check_output
        run: |
          if [ -f "tzydayauto.txt" ]; then
            echo "Output file created successfully!"
            echo "File details:"
            ls -la tzydayauto.txt
            echo "File size: $(wc -c < tzydayauto.txt) bytes"
            echo "First 30 lines of output file:"
            head -n 30 tzydayauto.txt
            echo "output_exists=true" >> $GITHUB_ENV
          else
            echo "ERROR: Output file tzydayauto.txt not created!"
            echo "Directory contents after script run:"
            find . -type f -name "*.txt" | sort
            echo "output_exists=false" >> $GITHUB_ENV
          fi
          
      - name: Create update status file
        run: |
          echo "Update status: $(date +'%Y-%m-%d %H:%M:%S')"
          echo "Output file created: ${{ env.output_exists }}"
          echo "Script exit code: ${{ env.script_exit_code }}"
          echo "Update status: $(date +'%Y-%m-%d %H:%M:%S')" > update_status.txt
          echo "Output file created: ${{ env.output_exists }}" >> update_status.txt
          echo "Script exit code: ${{ env.script_exit_code }}" >> update_status.txt
          
      - name: Configure Git with enhanced settings
        run: |
          echo "Configuring Git with enhanced settings..."
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          # æ·»åŠ è°ƒè¯•é…ç½®
          git config --global core.quotepath false
          git config --global push.default current
          git config --global advice.detachedHead false
          git config --global log.date iso-strict
          
          # æ˜¾ç¤ºé…ç½®ä¿¡æ¯
          echo "Git configuration:"
          git config --list
          
          # ä¿å­˜Gité…ç½®åˆ°æ—¥å¿—æ–‡ä»¶
          git config --list > git_config.log
          echo "Git config saved to git_config.log"
          
      - name: Add comprehensive Git status debugging
        run: |
          echo "=== GIT REPOSITORY DETAILED STATUS CHECK ==="
          echo "Current branch information:"
          git branch -a
          
          echo "\nRemote information:"
          git remote -v
          
          echo "\nFetching all remotes..."
          git fetch --all --prune --verbose
          
          echo "\nRemote refs status:"
          git ls-remote --heads origin
          
          echo "\nLocal vs Remote comparison:"
          git log --oneline HEAD..origin/main || echo "No commits ahead of origin/main"
          git log --oneline origin/main..HEAD || echo "No commits behind origin/main"
          
          echo "\nReference logs:"
          git reflog --head=5
          
          echo "\nGit object info:"
          git count-objects -v
          
          # ä¿å­˜è¯¦ç»†çŠ¶æ€åˆ°æ—¥å¿—æ–‡ä»¶
          mkdir -p git_debug_logs
          git status --verbose > git_debug_logs/status.log
          git log --oneline -n 10 > git_debug_logs/recent_commits.log
          git ls-remote > git_debug_logs/remote_refs.log
          
          echo "\nDetailed Git status saved to git_debug_logs/"
          echo "==============================================="
          
      - name: Add and commit changes with debug tracing
        run: |
          echo "Starting enhanced Git operations with debug tracing..."
          # ç¡®ä¿æˆ‘ä»¬åœ¨æ­£ç¡®çš„åˆ†æ”¯ä¸Š
          echo "Checking out main branch..."
          git checkout main || {
            echo "Failed to checkout main, trying to create from origin/main..."
            git checkout -b main origin/main
          }
          
          # è®°å½•åˆ†æ”¯çŠ¶æ€
          echo "Current branch status:"
          git status
          
          # 1. å¼ºåˆ¶è·å–æœ€æ–°ä»£ç ï¼Œç¡®ä¿å¼•ç”¨å®Œå…¨åŒæ­¥
          echo "Forcing fetch of latest changes..."
          git fetch --all --prune --force --verbose
          
          # 2. è¿è¡Œè„šæœ¬ç”Ÿæˆæœ€æ–°æ–‡ä»¶ (å¦‚æœå°šæœªè¿è¡Œ)
          echo "Generating output file if not exists..."
          if [ ! -f "tzydayauto.txt" ]; then
            python tvzydaily.py
          fi
          
          # 3. æ·»åŠ æ‰€æœ‰ç›¸å…³æ–‡ä»¶
          echo "Adding files to git..."
          git add tzydayauto.txt update_status.txt script_output.log git_debug_logs/* git_config.log
          
          # 4. æ£€æŸ¥æ˜¯å¦æœ‰æ›´æ”¹éœ€è¦æäº¤
          if ! git diff --quiet && ! git diff --staged --quiet; then
            # 4.1 æäº¤æ›´æ”¹
            echo "Committing changes..."
            git commit -m "Automated update of TVZY channels $(date +'%Y-%m-%d %H:%M:%S')" -v
            
            # 4.2 ä¿å­˜å½“å‰æœ¬åœ°æäº¤ä»¥ä¾¿åœ¨å†²çªæ—¶æ¢å¤
            LOCAL_COMMIT=$(git rev-parse HEAD)
            echo "Local commit saved: $LOCAL_COMMIT"
            
            # 4.3 åœ¨æ¨é€å‰å…ˆæ‰§è¡Œrebaseï¼Œç¡®ä¿ä¸è¿œç¨‹ä»£ç åŒæ­¥
            echo "Performing git pull --rebase before push..."
            if git pull --rebase origin main --verbose; then
              echo "Rebase successful, preparing to push..."
              # 4.4 æ¨é€æ›´æ”¹
              if git push origin HEAD:main --verbose; then
                echo "Push successful!"
                echo "push_status=success" >> $GITHUB_ENV
              else
                echo "Push failed, trying force push with lease..."
                # è®°å½•å¼•ç”¨çŠ¶æ€ç”¨äºè°ƒè¯•
                echo "Reference status before force-with-lease:"
                git show-ref main
                git show-ref origin/main
                
                # 4.5 å¦‚æœæ™®é€šæ¨é€å¤±è´¥ï¼Œå°è¯•ä½¿ç”¨force-with-leaseï¼ˆæ¯”æ™®é€šforceæ›´å®‰å…¨ï¼‰
                if git push --force-with-lease origin HEAD:main --verbose; then
                  echo "Force push with lease successful!"
                  echo "push_status=success_with_force_lease" >> $GITHUB_ENV
                else
                  echo "CRITICAL: Force push with lease failed!"
                  echo "Handling 'cannot lock ref' error scenario..."
                  
                  # è¯¦ç»†è®°å½•é”™è¯¯çŠ¶æ€
                  echo "=== DETAILED ERROR DIAGNOSTICS ===" > git_debug_logs/error_diagnostics.log
                  git show-ref >> git_debug_logs/error_diagnostics.log
                  git branch -vv >> git_debug_logs/error_diagnostics.log
                  git ls-remote --heads origin >> git_debug_logs/error_diagnostics.log
                  echo "================================" >> git_debug_logs/error_diagnostics.log
                  
                  # 4.6 å¤„ç†'cannot lock ref'é”™è¯¯ï¼Œè¿™æ˜¯æ›´ä¸¥é‡çš„å¼•ç”¨å†²çª
                  git fetch origin main --force --verbose
                  # å®Œå…¨é‡ç½®æœ¬åœ°å¼•ç”¨ä»¥åŒ¹é…è¿œç¨‹
                  git branch -D main 2>/dev/null || echo "Main branch not found, recreating..."
                  git checkout -b main origin/main --verbose
                  
                  # åº”ç”¨æˆ‘ä»¬çš„æ›´æ”¹
                  echo "Attempting to apply our changes..."
                  git cherry-pick $LOCAL_COMMIT || {
                    echo "Cherry-pick failed, recreating changes..."
                    # å¦‚æœcherry-pickå¤±è´¥ï¼Œé‡æ–°ç”Ÿæˆæ–‡ä»¶
                    python tvzydaily.py
                    git add tzydayauto.txt update_status.txt script_output.log git_debug_logs/* git_config.log
                    git commit -m "Automated update after ref reset $(date +'%Y-%m-%d %H:%M:%S')"
                  }
                  
                  # å†æ¬¡å°è¯•æ¨é€
                  if git push origin HEAD:main --verbose; then
                    echo "Push successful after reference reset!"
                    echo "push_status=success_after_ref_reset" >> $GITHUB_ENV
                  else
                    echo "ULTIMATE FAILURE: All push attempts failed after reference reset!"
                    echo "push_status=failure_after_multiple_attempts" >> $GITHUB_ENV
                    
                    # ä¿å­˜æœ€ç»ˆé”™è¯¯çŠ¶æ€
                    echo "=== FINAL ERROR STATE ===" > git_debug_logs/final_error.log
                    git status >> git_debug_logs/final_error.log
                    git show-ref >> git_debug_logs/final_error.log
                    echo "================================" >> git_debug_logs/final_error.log
                    exit 1
                  fi
                fi
              fi
            else
              echo "Rebase failed, attempting to resolve conflicts..."
              # 4.7 å¤„ç†rebaseå†²çª - å¼ºåˆ¶é‡ç½®ç­–ç•¥
              git rebase --abort || true
              git fetch origin main --force --verbose
              # ä½¿ç”¨æ›´æ¿€è¿›çš„é‡ç½®ç­–ç•¥
              echo "Hard resetting to origin/main and reapplying our changes..."
              git reset --hard origin/main --verbose
              # é‡æ–°ç”Ÿæˆæ–‡ä»¶
              python tvzydaily.py
              git add tzydayauto.txt update_status.txt script_output.log git_debug_logs/* git_config.log
              git commit -m "Automated update after conflict resolution $(date +'%Y-%m-%d %H:%M:%S')" -v
              # å†æ¬¡å°è¯•æ¨é€
              if git push origin HEAD:main --verbose; then
                echo "Push successful after conflict resolution!"
                echo "push_status=success_after_conflict_resolution" >> $GITHUB_ENV
              else
                echo "Push failed after conflict resolution, trying force push with lease..."
                if git push --force-with-lease origin HEAD:main --verbose; then
                  echo "Force push with lease successful after conflict resolution!"
                  echo "push_status=success_with_force_lease_after_conflict" >> $GITHUB_ENV
                else
                  echo "Final push attempt failed after all resolution attempts!"
                  echo "push_status=failure"
                  # ä¿å­˜æœ€ç»ˆé”™è¯¯çŠ¶æ€
                  echo "=== CONFLICT RESOLUTION ERROR STATE ===" > git_debug_logs/conflict_error.log
                  git status >> git_debug_logs/conflict_error.log
                  echo "================================" >> git_debug_logs/conflict_error.log
                  exit 1
                fi
              fi
            fi
          else
            echo "No changes to commit"
            echo "push_status=nothing_to_push" >> $GITHUB_ENV
          fi
          
          # ä¿å­˜æ“ä½œåçš„çŠ¶æ€
          git status > git_debug_logs/post_operation_status.log
          echo "Enhanced Git operations completed successfully with debug info saved!"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          
      - name: Update status file with comprehensive git results
        run: |
          echo "[INFO] Updating status file with comprehensive git operation results..."
          # åˆ›å»ºæ–°çš„çŠ¶æ€æ–‡ä»¶è€Œä¸æ˜¯è¿½åŠ ï¼Œä»¥é¿å…ä¿¡æ¯é‡å¤
          cat > update_status.txt << EOF
Update status: $(date +'%Y-%m-%d %H:%M:%S')
Output file created: ${{ env.output_exists }}
Script exit code: ${{ env.script_exit_code }}
Git push status: ${{ env.push_status || 'unknown' }}
GitHub Run ID: ${{ github.run_id }}
GitHub Run Number: ${{ github.run_number }}
GitHub Actor: ${{ github.actor }}
Repository: ${{ github.repository }}
EOF
          
          # æ ¹æ®ä¸åŒçš„æ¨é€çŠ¶æ€æ·»åŠ ä¸åŒçš„ä¿¡æ¯
          case "${{ env.push_status }}" in
            "success")
              echo "[SUCCESS] Update completed successfully with standard push" >> update_status.txt
              ;;
            "success_with_force_lease")
              echo "[WARNING] Update completed with force-with-lease push" >> update_status.txt
              ;;
            "success_after_conflict_resolution")
              echo "[INFO] Update completed after resolving conflicts" >> update_status.txt
              ;;
            "success_after_ref_reset")
              echo "[WARNING] Update completed after reference reset due to 'cannot lock ref' error" >> update_status.txt
              ;;
            "failure_after_multiple_attempts")
              echo "[CRITICAL] All push attempts failed after multiple resolution strategies" >> update_status.txt
              echo "[ERROR] Manual intervention required to resolve repository inconsistencies" >> update_status.txt
              ;;
            "failure")
              echo "[ERROR] Update failed due to Git push conflicts or other errors" >> update_status.txt
              ;;
            "nothing_to_push")
              echo "[INFO] No changes detected, nothing to push" >> update_status.txt
              ;;
            *)
              echo "[WARNING] Unknown push status" >> update_status.txt
              ;;
          esac
          
          echo "Update completed at: $(date +'%Y-%m-%d %H:%M:%S')" >> update_status.txt
          
          # æ£€æŸ¥æ˜¯å¦æœ‰é”™è¯¯æ—¥å¿—ç›®å½•å¹¶æ·»åŠ ä¿¡æ¯
          if [ -d "git_debug_logs" ]; then
            echo "\nDebug information available in git_debug_logs/ directory" >> update_status.txt
            echo "Debug logs: $(ls -la git_debug_logs/)" >> update_status.txt
          fi
          
          # æ›´æ–°çŠ¶æ€æ–‡ä»¶
          git add update_status.txt
          if git diff --staged --quiet; then
            echo "No changes to status file to commit"
          else
            echo "Committing updated status file..."
            git commit --amend --no-edit && echo "Status file committed successfully"
            # å°è¯•æ¨é€çŠ¶æ€æ›´æ–°ï¼Œä½†ä¸ä¸­æ–­æµç¨‹
            git push --force-with-lease origin HEAD:main || {
              echo "Failed to update status file in remote, but continuing workflow"
              # å¦‚æœæ¨é€å¤±è´¥ï¼Œè‡³å°‘ä¿å­˜åˆ°æœ¬åœ°
              cp update_status.txt status_backup.txt
              echo "Status file backed up to status_backup.txt"
            }
          fi
          
          # æ˜¾ç¤ºæœ€ç»ˆçŠ¶æ€
          echo "\n=== FINAL STATUS ==="
          cat update_status.txt
          echo "====================="
          
      - name: Upload comprehensive debugging artifacts
        uses: actions/upload-artifact@v3
        with:
          name: workflow-debug-logs-${{ github.run_id }}
          path: |
            script_output.log
            update_status.txt
            status_backup.txt
            tzydayauto.txt
            git_config.log
            git_debug_logs/
          retention-days: 14
          if-no-files-found: warn
          
      - name: Send detailed success notification
        if: success()
        run: |
          echo "âœ… TVZY Daily Update completed successfully!"
          echo "ğŸ“Š Execution Summary:"
          echo "- Push status: ${{ env.push_status }}"
          echo "- Run ID: ${{ github.run_id }}"
          echo "- Repository: ${{ github.repository }}"
          echo "- Branch: ${{ github.ref }}"
          echo "- Commit: ${{ github.sha }}"
          echo "- Logs available as workflow artifacts (retention: 14 days)"
          
          # æ ¹æ®ä¸åŒçš„æˆåŠŸçŠ¶æ€æ˜¾ç¤ºä¸åŒçš„æç¤º
          case "${{ env.push_status }}" in
            "success")
              echo "âœ… Standard push completed successfully"
              ;;
            "success_with_force_lease")
              echo "âš ï¸  Force-with-lease push was required"
              echo "   This indicates potential branch divergence that was safely resolved"
              ;;
            "success_after_conflict_resolution")
              echo "ğŸ”„ Conflict resolution was successful"
              echo "   Local changes were merged with remote updates"
              ;;
            "success_after_ref_reset")
              echo "ğŸ”„ Repository reference was reset to resolve 'cannot lock ref' error"
              echo "   This is an expected recovery mechanism for reference inconsistencies"
              ;;
          esac
          
          echo "ğŸ“š Troubleshooting Resources:"
          echo "- View complete logs in the 'Artifacts' section"
          echo "- Check update_status.txt for detailed operation results"
          
      - name: Send detailed failure notification
        if: failure()
        run: |
          echo "âŒ TVZY Daily Update failed!"
          echo "ğŸ“Š Error Summary:"
          echo "- Push status: ${{ env.push_status || 'unknown' }}"
          echo "- Run ID: ${{ github.run_id }}"
          echo "- Repository: ${{ github.repository }}"
          echo "- Branch: ${{ github.ref }}"
          
          # æ ¹æ®ä¸åŒçš„å¤±è´¥çŠ¶æ€æä¾›é’ˆå¯¹æ€§çš„è§£å†³å»ºè®®
          case "${{ env.push_status }}" in
            "failure_after_multiple_attempts")
              echo "ğŸ”´ CRITICAL: Multiple resolution attempts failed"
              echo "   Recommendation: Repository might have serious reference inconsistencies"
              echo "   Resolution Steps:"
              echo "   1. Clone a fresh copy of the repository"
              echo "   2. Run the update script locally"
              echo "   3. Push changes manually with proper authentication"
              echo "   4. Check for any concurrent workflows running on the same branch"
              ;;
            "failure")
              echo "ğŸ”´ General Git push failure occurred"
              echo "   Recommendation: Check for concurrent updates or permission issues"
              echo "   Resolution Steps:"
              echo "   1. Check if multiple workflows are running simultaneously"
              echo "   2. Verify GITHUB_TOKEN has sufficient permissions"
              echo "   3. Ensure branch protection rules allow force-with-lease pushes if needed"
              ;;
            *)
              echo "ğŸ”´ Unknown failure reason"
              echo "   Recommendation: Examine detailed logs for root cause"
              ;;
          esac
          
          echo "ğŸ“š Detailed Debugging Information:"
          echo "- All debug logs are available as workflow artifacts"
          echo "- Check git_debug_logs/ directory for detailed Git operations history"
          echo "- Review error_diagnostics.log for specific Git reference errors"
          
          echo "ğŸ”„ Next Steps:"
          echo "- If this persists, consider scheduling workflow runs at staggered times"
          echo "- For 'cannot lock ref' errors, check if branch protection rules are too restrictive"
          echo "- Consider implementing a mutex mechanism if running concurrent updates"
