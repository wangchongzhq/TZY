name: TVZY Daily Update

on:
  # æ¯å¤©å®šæ—¶è¿è¡Œ
  schedule:
    - cron: '0 1 * * *'  # æ¯å¤©1:00 UTCè¿è¡Œï¼ˆåŒ—äº¬æ—¶é—´9:00ï¼‰
  # å…è®¸æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      logLevel:
        description: 'Log level'
        required: true
        default: 'info'

jobs:
  update-tv-channels:
    runs-on: ubuntu-latest
    # æ·»åŠ é€‚å½“çš„æƒé™è®¾ç½®ï¼Œç¡®ä¿äº’æ–¥é”è„šæœ¬å¯ä»¥è®¿é—®GitHub API
    permissions:
      # è¯»å–å·¥ä½œæµè¿è¡ŒçŠ¶æ€ï¼Œç”¨äºäº’æ–¥é”æ£€æŸ¥
      actions: read
      # è¯»å–ä»“åº“å†…å®¹ï¼Œç”¨äºæ£€æŸ¥å’Œæ›´æ–°æ–‡ä»¶
      contents: write
      # è¯»å–å·¥ä½œæµå®šä¹‰
      workflows: read
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0  # è·å–å®Œæ•´å†å²
          persist-credentials: true
          token: ${{ secrets.GITHUB_TOKEN }}
          
      - name: ğŸ”’ å¢å¼ºå‹å·¥ä½œæµäº’æ–¥é”æ£€æŸ¥
        id: mutex_check
        run: |
          echo "Starting enhanced workflow mutual exclusion check..."
          
          # ç¡®ä¿æ—¥å¿—ç›®å½•å­˜åœ¨
          mkdir -p mutex_logs
          
          # è°ƒç”¨å¢å¼ºçš„äº’æ–¥é”è„šæœ¬ï¼Œå¯ç”¨æ‰€æœ‰é«˜çº§åŠŸèƒ½
          python workflow_mutex.py \
            --owner "${{ github.repository_owner }}" \
            --repo "${{ github.event.repository.name || github.repository }}" \
            --workflow "TVZY Daily Update" \
            --token "${{ secrets.GITHUB_TOKEN }}" \
            --wait \
            --max-wait 300 \
            --fallback \
            --persist-lock \
            --log-level info \
            --retry-count 3 \
            --retry-interval 5 \
            --lock-file "mutex_logs/workflow_lock.json"
          
          # æ•è·è„šæœ¬é€€å‡ºç 
          MUTEX_RESULT=$?
          echo "Mutex check result: $MUTEX_RESULT"
          echo "mutex_result=$MUTEX_RESULT" >> $GITHUB_ENV
          
          # æ£€æŸ¥æ˜¯å¦ä½¿ç”¨äº†å¤‡é€‰ç­–ç•¥
          if [ -f "used_api_fallback.txt" ]; then
            echo "API fallback was used, switching to API update mode"
            echo "using_api_fallback=true" >> $GITHUB_ENV
          else
            echo "using_api_fallback=false" >> $GITHUB_ENV
          fi
          
          # æ£€æŸ¥é”çŠ¶æ€æ–‡ä»¶ï¼Œç”¨äºåç»­è°ƒè¯•
          if [ -f "mutex_logs/workflow_lock.json" ]; then
            echo "Lock status file exists, saving lock details..."
            cat mutex_logs/workflow_lock.json
          fi
          
          # å¦‚æœäº’æ–¥é”æ£€æŸ¥å¤±è´¥ä¸”æ²¡æœ‰å¤‡é€‰ç­–ç•¥ï¼Œç»ˆæ­¢å·¥ä½œæµ
          if [ $MUTEX_RESULT -ne 0 ] && [ ! -f "used_api_fallback.txt" ]; then
            echo "âŒ Failed to acquire mutex and no fallback available"
            exit 1
          fi
          echo "âœ… Enhanced mutual exclusion check completed successfully"
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
          
      - name: Install dependencies with verbose logging
        run: |
          python --version
          python -m pip --version
          python -m pip install --upgrade pip
          pip install requests schedule
          pip list
          
      - name: Debug environment
        run: |
          echo "Current directory: $(pwd)"
          echo "Directory contents:"
          ls -la
          echo "Python path: $(which python)"
          echo "Python env:"
          python -c "import sys; print(sys.path)"
      
      - name: Create test output directory if needed
        run: mkdir -p output
        
      - name: Run TVZY update script with debug
        id: run_script
        run: |
          echo "Starting TVZY update script..."
          python -u tvzydaily.py 2>&1 | tee script_output.log
          EXIT_CODE=${PIPESTATUS[0]}
          echo "Script exit code: $EXIT_CODE"
          echo "script_exit_code=$EXIT_CODE" >> $GITHUB_ENV
          
      - name: Check script output and logs
        run: |
          echo "=== Script output log ==="
          cat script_output.log || echo "No script output log found"
          
          echo "=== Python errors ==="
          grep -i "error\|exception\|fail" script_output.log || echo "No obvious errors found"
          
          echo "=== Current directory after script ==="
          ls -la
          
      - name: Check if output file exists
        id: check_output
        run: |
          if [ -f "tzydayauto.txt" ]; then
            echo "Output file created successfully!"
            echo "File details:"
            ls -la tzydayauto.txt
            echo "File size: $(wc -c < tzydayauto.txt) bytes"
            echo "First 30 lines of output file:"
            head -n 30 tzydayauto.txt
            echo "output_exists=true" >> $GITHUB_ENV
          else
            echo "ERROR: Output file tzydayauto.txt not created!"
            echo "Directory contents after script run:"
            find . -type f -name "*.txt" | sort
            echo "output_exists=false" >> $GITHUB_ENV
          fi
          
      - name: Create update status file
        run: |
          echo "Update status: $(date +'%Y-%m-%d %H:%M:%S')"
          echo "Output file created: ${{ env.output_exists }}"
          echo "Script exit code: ${{ env.script_exit_code }}"
          echo "Update status: $(date +'%Y-%m-%d %H:%M:%S')" > update_status.txt
          echo "Output file created: ${{ env.output_exists }}" >> update_status.txt
          echo "Script exit code: ${{ env.script_exit_code }}" >> update_status.txt
          
      - name: Configure Git with enhanced settings
        run: |
          echo "Configuring Git with enhanced settings..."
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          # æ·»åŠ è°ƒè¯•é…ç½®
          git config --global core.quotepath false
          git config --global push.default current
          git config --global advice.detachedHead false
          git config --global log.date iso-strict
          
          # æ˜¾ç¤ºé…ç½®ä¿¡æ¯
          echo "Git configuration:"
          git config --list
          
          # ä¿å­˜Gité…ç½®åˆ°æ—¥å¿—æ–‡ä»¶
          git config --list > git_config.log
          echo "Git config saved to git_config.log"
          
      - name: Enhanced Git status debugging with advanced conflict prevention
        run: |
          echo "=== ENHANCED GIT REPOSITORY STATUS CHECK AND CONFLICT PREVENTION ==="
          # å¢å¼ºçš„è¯Šæ–­æ—¥å¿—
          mkdir -p git_debug_logs
          
          # 1. åŸºç¡€ä¿¡æ¯æ”¶é›†
          echo "[INFO] Collecting repository information..."
          echo "Current branch information:"
          git branch -a
          
          echo "\nRemote information:"
          git remote -v
          
          # 2. å¼ºåŒ–fetchæ“ä½œï¼Œç¡®ä¿å®Œå…¨åŒæ­¥ - ä½¿ç”¨æ›´å¯é çš„åŒæ­¥ç­–ç•¥
          echo "\n[IMPORTANT] Performing synchronized fetch operations..."
          # é¦–å…ˆè®¾ç½®å®‰å…¨çš„fetché€‰é¡¹
          git config --global fetch.prune true
          git config --global fetch.pruneTags true
          
          # æ‰§è¡Œå¤šæ¬¡fetchç¡®ä¿åŒæ­¥
          for i in {1..3}; do
            echo "Fetch attempt $i/3..."
            if git fetch origin main --prune --force --tags --verbose; then
              echo "âœ… Fetch successful"
              break
            else
              echo "âŒ Fetch attempt $i failed, retrying..."
              sleep 2
            fi
          done
          
          # ç¡®ä¿æ‰€æœ‰å¼•ç”¨éƒ½å·²æ›´æ–°
          git fetch --all --prune --force --tags --verbose
          
          # 3. è¯¦ç»†çš„å¼•ç”¨çŠ¶æ€æ£€æŸ¥ä¸å·®å¼‚åˆ†æ
          echo "\n[DETAILED] Remote refs status:"
          git ls-remote --heads origin > git_debug_logs/remote_heads.log
          cat git_debug_logs/remote_heads.log
          
          echo "\n[CRITICAL] Local vs Remote comparison:"
          # æ£€æŸ¥æœ¬åœ°æ˜¯å¦æœ‰è¿œç¨‹æ²¡æœ‰çš„æäº¤
          LOCAL_AHEAD_COUNT=$(git log --oneline HEAD..origin/main 2>/dev/null | wc -l)
          if [ $LOCAL_AHEAD_COUNT -gt 0 ]; then
            echo "âš ï¸  CRITICAL WARNING: Local branch is AHEAD of remote by $LOCAL_AHEAD_COUNT commits!"
            echo "âš ï¸  This WILL cause 'fetch first' errors during push."
            echo "âš ï¸  Immediate action required to resolve divergence."
            # è®°å½•è¯¦ç»†çš„åˆ†æ­§ä¿¡æ¯
            git log --oneline -p HEAD..origin/main > git_debug_logs/local_ahead_details.log
            echo "Local ahead details saved to git_debug_logs/local_ahead_details.log"
            # ç«‹å³å‡†å¤‡å†²çªè§£å†³
            echo "[ACTION] Preparing conflict resolution strategy..."
            # è®¾ç½®ç¯å¢ƒå˜é‡æ ‡è®°éœ€è¦å¼ºåˆ¶é‡ç½®
            echo "GIT_REQUIRES_RESET=true" >> $GITHUB_ENV
          else
            echo "âœ… Local branch is not ahead of remote"
          fi
          
          # æ£€æŸ¥æœ¬åœ°æ˜¯å¦è½åäºè¿œç¨‹
          LOCAL_BEHIND_COUNT=$(git log --oneline origin/main..HEAD 2>/dev/null | wc -l)
          if [ $LOCAL_BEHIND_COUNT -gt 0 ]; then
            echo "âš ï¸  WARNING: Local branch is BEHIND remote by $LOCAL_BEHIND_COUNT commits"
            echo "âš ï¸  Will attempt to rebase before push"
            git log --oneline -p origin/main..HEAD > git_debug_logs/local_behind_details.log
            echo "Local behind details saved to git_debug_logs/local_behind_details.log"
          else
            echo "âœ… Local branch is not behind remote"
          fi
          
          # 4. å¢å¼ºçš„å¼•ç”¨å®Œæ•´æ€§æ£€æŸ¥
          echo "\n[VERIFICATION] Reference integrity check:"
          git show-ref main > git_debug_logs/show_ref_main.log || echo "main reference not found"
          git show-ref origin/main > git_debug_logs/show_ref_origin_main.log || echo "origin/main reference not found"
          
          # æ£€æŸ¥HEADå¼•ç”¨
          echo "\nHEAD reference:"
          git rev-parse HEAD
          
          echo "\nReference logs:"
          git reflog --head=5
          
          # 5. ä¿å­˜å®Œæ•´çš„è¯Šæ–­ä¿¡æ¯ç”¨äºåç»­åˆ†æ
          git status --verbose > git_debug_logs/status.log
          git log --oneline -n 20 > git_debug_logs/recent_commits.log
          git ls-remote > git_debug_logs/remote_refs.log
          git branch -vv > git_debug_logs/branch_details.log
          
          # 6. å¼•ç”¨ä¸€è‡´æ€§æ£€æŸ¥
          echo "\n[INTEGRITY] Reference consistency check:"
          LOCAL_MAIN=$(git show-ref -s main 2>/dev/null || echo "not found")
          REMOTE_MAIN=$(git show-ref -s origin/main 2>/dev/null || echo "not found")
          CURRENT_HEAD=$(git rev-parse HEAD)
          
          echo "Local main: $LOCAL_MAIN"
          echo "Remote main: $REMOTE_MAIN"
          echo "Current HEAD: $CURRENT_HEAD"
          
          # è®°å½•è¿™äº›ä¿¡æ¯ç”¨äºåç»­è°ƒè¯•
          echo "LOCAL_MAIN=$LOCAL_MAIN" >> git_debug_logs/reference_info.env
          echo "REMOTE_MAIN=$REMOTE_MAIN" >> git_debug_logs/reference_info.env
          echo "CURRENT_HEAD=$CURRENT_HEAD" >> git_debug_logs/reference_info.env
          
          echo "\nEnhanced Git status and conflict prevention completed"
          echo "==============================================================="
          
      - name: Ultra-robust commit and push with advanced conflict resolution
        run: |
          echo "=== ULTRA-ROBUST GIT OPERATIONS WITH ADVANCED CONFLICT RESOLUTION ==="
          
          # æ£€æŸ¥æ˜¯å¦ä½¿ç”¨APIå¤‡é€‰æ¨¡å¼
          if [ "${{ env.using_api_fallback }}" = "true" ]; then
            echo "âš ï¸  Using API fallback mode due to workflow conflicts"
            echo "Performing file updates via GitHub API instead of Git"
            
            # ä½¿ç”¨GitHub APIç›´æ¥æ›´æ–°æ–‡ä»¶
            python github_api_updater.py \
              --token "${{ secrets.GITHUB_TOKEN }}" \
              --owner "${{ github.repository_owner }}" \
              --repo "${{ github.event.repository.name || github.repository }}" \
              --file "tzydayauto.txt" \
              --message "API-based update after workflow conflict detection"
            
            # æ£€æŸ¥APIæ›´æ–°æ˜¯å¦æˆåŠŸ
            if [ $? -eq 0 ]; then
              echo "âœ… File updated successfully via GitHub API"
              echo "push_status=success_with_github_api" >> $GITHUB_ENV
            else
              echo "âŒ GitHub API update failed"
              echo "push_status=failure_api_update" >> $GITHUB_ENV
            fi
            
            # ç”±äºä½¿ç”¨APIæ›´æ–°ï¼Œè·³è¿‡åç»­Gitæ“ä½œ
            exit 0
          fi
          echo "ğŸ”„ Continuing with standard Git operations"
          
          # æ£€æŸ¥æ˜¯å¦éœ€è¦æ‰§è¡Œé‡ç½®æ“ä½œï¼ˆæ¥è‡ªå‰é¢çš„å†²çªæ£€æµ‹æ­¥éª¤ï¼‰
          if [ "${{ env.GIT_REQUIRES_RESET }}" == "true" ]; then
            echo "[CRITICAL ACTION] Detected local branch divergence from earlier check, executing reset strategy..."
            
            # ä¿å­˜å½“å‰çš„ä¿®æ”¹å†…å®¹åˆ°ä¸´æ—¶ç›®å½•
            echo "Saving current changes to temporary location..."
            mkdir -p git_backup
            
            # å¼ºåˆ¶é‡ç½®åˆ°è¿œç¨‹åˆ†æ”¯
            echo "Performing hard reset to origin/main..."
            git reset --hard origin/main
            
            echo "Reset completed, will regenerate changes..."
            echo "RESET_PERFORMED=true" >> $GITHUB_ENV
          fi
          
          # ç¡®ä¿æˆ‘ä»¬åœ¨æ­£ç¡®çš„åˆ†æ”¯ä¸Š
          echo "Checking out main branch..."
          git checkout main || {
            echo "Failed to checkout main, trying to create from origin/main..."
            git checkout -b main origin/main
          }
          
          # è®°å½•åˆ†æ”¯çŠ¶æ€
          echo "Current branch status:"
          git status
          
          # 1. å¼ºåˆ¶è·å–æœ€æ–°ä»£ç ï¼Œç¡®ä¿å¼•ç”¨å®Œå…¨åŒæ­¥
          echo "Forcing fetch of latest changes..."
          git fetch --all --prune --force --verbose
          
          # 2. è¿è¡Œè„šæœ¬ç”Ÿæˆæœ€æ–°æ–‡ä»¶ (å¦‚æœå°šæœªè¿è¡Œ)
          echo "Generating output file if not exists..."
          if [ ! -f "tzydayauto.txt" ]; then
            python tvzydaily.py
          fi
          
          # 3. æ·»åŠ æ‰€æœ‰ç›¸å…³æ–‡ä»¶
          echo "Adding files to git..."
          git add tzydayauto.txt update_status.txt script_output.log git_debug_logs/* git_config.log
          
          # 4. æ£€æŸ¥æ˜¯å¦æœ‰æ›´æ”¹éœ€è¦æäº¤
          if ! git diff --quiet && ! git diff --staged --quiet; then
            # 4.1 æäº¤æ›´æ”¹
            echo "Committing changes..."
            git commit -m "Automated update of TVZY channels $(date +'%Y-%m-%d %H:%M:%S')" -v
            
            # 4.2 ä¿å­˜å½“å‰æœ¬åœ°æäº¤ä»¥ä¾¿åœ¨å†²çªæ—¶æ¢å¤
            LOCAL_COMMIT=$(git rev-parse HEAD)
            echo "Local commit saved: $LOCAL_COMMIT"
            
            # 4.3 åœ¨æ¨é€å‰å…ˆæ‰§è¡Œrebaseï¼Œç¡®ä¿ä¸è¿œç¨‹ä»£ç åŒæ­¥
            echo "Performing git pull --rebase before push..."
            if git pull --rebase origin main --verbose; then
              echo "Rebase successful, preparing to push..."
              # 4.4 æ¨é€æ›´æ”¹ - å¢å¼ºçš„æ¨é€ç­–ç•¥
                  echo "Attempting push with retry mechanism..."
                  
                  # å®šä¹‰æœ€å¤§é‡è¯•æ¬¡æ•°
                  MAX_PUSH_ATTEMPTS=3
                  CURRENT_ATTEMPT=1
                  
                  # ç¬¬ä¸€æ¬¡å°è¯•ï¼šæ™®é€šæ¨é€
                  while [ $CURRENT_ATTEMPT -le $MAX_PUSH_ATTEMPTS ]; do
                    echo "\n[PUSH ATTEMPT $CURRENT_ATTEMPT/$MAX_PUSH_ATTEMPTS]"
                    
                    if git push origin HEAD:main --verbose; then
                      echo "âœ… Push successful on attempt $CURRENT_ATTEMPT!"
                      echo "push_status=success" >> $GITHUB_ENV
                      echo "push_strategy=normal_push_attempt_$CURRENT_ATTEMPT" >> $GITHUB_ENV
                      break
                    else
                      echo "âŒ Push attempt $CURRENT_ATTEMPT failed"
                      
                      # æ•è·é”™è¯¯æ¶ˆæ¯ç”¨äºåˆ†æ
                      PUSH_ERROR=$(git push origin HEAD:main 2>&1)
                      echo "Error details: $PUSH_ERROR"
                      
                      # å¦‚æœæ˜¯æœ€åä¸€æ¬¡å°è¯•ï¼Œä½¿ç”¨æ›´å¼ºåŠ›çš„ç­–ç•¥
                      if [ $CURRENT_ATTEMPT -eq $MAX_PUSH_ATTEMPTS ]; then
                        echo "[STRATEGY] Final attempt - using force-with-lease..."
                        
                        # è®°å½•å¼•ç”¨çŠ¶æ€ç”¨äºè°ƒè¯•
                        echo "Reference status before force-with-lease:"
                        git show-ref main
                        git show-ref origin/main
                        
                        # ä½¿ç”¨force-with-leaseï¼ˆæ¯”æ™®é€šforceæ›´å®‰å…¨ï¼‰
                        if git push --force-with-lease origin HEAD:main --verbose; then
                          echo "âœ… Force push with lease successful!"
                          echo "push_status=success_with_force_lease" >> $GITHUB_ENV
                          echo "push_strategy=force_with_lease" >> $GITHUB_ENV
                          break
                        else
                          echo "âŒ Force push with lease failed"
                          
                          # æ£€æŸ¥å…·ä½“çš„é”™è¯¯ç±»å‹
                          if echo "$PUSH_ERROR" | grep -q "fetch first"; then
                            echo "[CRITICAL] 'fetch first' error detected - executing advanced resolution strategy"
                            
                            # ç­–ç•¥ï¼šä¸‰å‘åˆå¹¶å¹¶ä½¿ç”¨ç‰¹å®šçš„åˆå¹¶ç­–ç•¥
                            echo "[ADVANCED STRATEGY] Three-way merge with conflict resolution..."
                            
                            # ä¿å­˜å½“å‰æäº¤å’ŒçŠ¶æ€
                            TEMP_COMMIT=$(git commit-tree HEAD^{tree} -p HEAD -p origin/main -m "Temp merge commit")
                            git checkout -b temp_resolution_branch $TEMP_COMMIT
                            
                            # å°è¯•åœ¨ä¸´æ—¶åˆ†æ”¯ä¸Šè§£å†³å†²çª
                            if python tvzydaily.py && git add tzydayauto.txt update_status.txt; then
                              git commit --amend -m "Automated update after three-way merge $(date +'%Y-%m-%d %H:%M:%S')"
                              
                              # å°è¯•ä»ä¸´æ—¶åˆ†æ”¯æ¨é€
                              if git push origin temp_resolution_branch:main --force-with-lease; then
                                echo "âœ… Three-way merge resolution successful!"
                                echo "push_status=success_after_three_way_merge" >> $GITHUB_ENV
                                echo "push_strategy=three_way_merge" >> $GITHUB_ENV
                                break
                              fi
                            fi
                          fi
                          
                          # å¦‚æœæ‰€æœ‰ç­–ç•¥éƒ½å¤±è´¥ï¼Œæ‰§è¡Œå¼•ç”¨é‡ç½®
                          echo "[LAST RESORT] Executing reference reset strategy..."
                          
                          # è¯¦ç»†è®°å½•é”™è¯¯çŠ¶æ€
                          echo "=== DETAILED ERROR DIAGNOSTICS ===" > git_debug_logs/error_diagnostics.log
                          git show-ref >> git_debug_logs/error_diagnostics.log
                          git branch -vv >> git_debug_logs/error_diagnostics.log
                          git ls-remote --heads origin >> git_debug_logs/error_diagnostics.log
                          echo "Push error: $PUSH_ERROR" >> git_debug_logs/error_diagnostics.log
                          echo "================================" >> git_debug_logs/error_diagnostics.log
                          
                          # å¼ºåˆ¶è·å–æœ€æ–°ä»£ç 
                          git fetch origin main --force --verbose
                          
                          # å®Œå…¨é‡ç½®æœ¬åœ°å¼•ç”¨ä»¥åŒ¹é…è¿œç¨‹
                          git branch -D main 2>/dev/null || echo "Main branch not found, recreating..."
                          git checkout -b main origin/main --verbose
                          
                          # é‡æ–°ç”Ÿæˆæ›´æ”¹
                          echo "Regenerating changes from scratch..."
                          python tvzydaily.py
                          git add tzydayauto.txt update_status.txt script_output.log git_debug_logs/* git_config.log
                          git commit -m "Automated update after forced reset $(date +'%Y-%m-%d %H:%M:%S') [Resolved 'fetch first' error]"
                          
                          # æœ€åå°è¯•æ¨é€
                          if git push origin HEAD:main --force-with-lease; then
                            echo "âœ… Push successful after complete reset!"
                            echo "push_status=success_after_complete_reset" >> $GITHUB_ENV
                            echo "push_strategy=complete_reset" >> $GITHUB_ENV
                            break
                          else
                            echo "âŒ FINAL FAILURE: All push attempts failed after complete reset!"
                            echo "push_status=failure_after_multiple_attempts" >> $GITHUB_ENV
                            echo "push_strategy=all_failed" >> $GITHUB_ENV
                            
                            # ä¿å­˜æœ€ç»ˆé”™è¯¯çŠ¶æ€
                            echo "=== FINAL ERROR STATE ===" > git_debug_logs/final_error.log
                            git status >> git_debug_logs/final_error.log
                            git show-ref >> git_debug_logs/final_error.log
                            echo "Push error: $PUSH_ERROR" >> git_debug_logs/final_error.log
                            echo "================================" >> git_debug_logs/final_error.log
                            exit 1
                          fi
                        fi
                      else
                        # å¦‚æœä¸æ˜¯æœ€åä¸€æ¬¡å°è¯•ï¼Œå¢åŠ å°è¯•æ¬¡æ•°å¹¶çŸ­æš‚ç­‰å¾…
                        CURRENT_ATTEMPT=$((CURRENT_ATTEMPT + 1))
                        echo "Retrying in 2 seconds..."
                        sleep 2
                        
                        # åœ¨é‡è¯•å‰é‡æ–°fetch
                        echo "Re-fetching latest changes before retry..."
                        git fetch origin main --prune --force
                      fi
                    fi
                  done
              fi
            else
              echo "Rebase failed, attempting to resolve conflicts..."
              # 4.7 å¤„ç†rebaseå†²çª - å¼ºåˆ¶é‡ç½®ç­–ç•¥
              git rebase --abort || true
              git fetch origin main --force --verbose
              # ä½¿ç”¨æ›´æ¿€è¿›çš„é‡ç½®ç­–ç•¥
              echo "Hard resetting to origin/main and reapplying our changes..."
              git reset --hard origin/main --verbose
              # é‡æ–°ç”Ÿæˆæ–‡ä»¶
              python tvzydaily.py
              git add tzydayauto.txt update_status.txt script_output.log git_debug_logs/* git_config.log
              git commit -m "Automated update after conflict resolution $(date +'%Y-%m-%d %H:%M:%S')" -v
              # å†æ¬¡å°è¯•æ¨é€
              if git push origin HEAD:main --verbose; then
                echo "Push successful after conflict resolution!"
                echo "push_status=success_after_conflict_resolution" >> $GITHUB_ENV
              else
                echo "Push failed after conflict resolution, trying force push with lease..."
                if git push --force-with-lease origin HEAD:main --verbose; then
                  echo "Force push with lease successful after conflict resolution!"
                  echo "push_status=success_with_force_lease_after_conflict" >> $GITHUB_ENV
                else
                  echo "Final push attempt failed after all resolution attempts!"
                  echo "push_status=failure"
                  # ä¿å­˜æœ€ç»ˆé”™è¯¯çŠ¶æ€
                  echo "=== CONFLICT RESOLUTION ERROR STATE ===" > git_debug_logs/conflict_error.log
                  git status >> git_debug_logs/conflict_error.log
                  echo "================================" >> git_debug_logs/conflict_error.log
                  exit 1
                fi
              fi
            fi
          else
            echo "No changes to commit"
            echo "push_status=nothing_to_push" >> $GITHUB_ENV
          fi
          
          # ä¿å­˜æ“ä½œåçš„çŠ¶æ€
          git status > git_debug_logs/post_operation_status.log
          echo "Enhanced Git operations completed successfully with debug info saved!"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          
      - name: Update status file with comprehensive git results
        run: |
          echo "[INFO] Updating status file with comprehensive git operation results..."
          # åˆ›å»ºæ–°çš„çŠ¶æ€æ–‡ä»¶è€Œä¸æ˜¯è¿½åŠ ï¼Œä»¥é¿å…ä¿¡æ¯é‡å¤
          cat > update_status.txt << EOF
Update status: $(date +'%Y-%m-%d %H:%M:%S')
Output file created: ${{ env.output_exists }}
Script exit code: ${{ env.script_exit_code }}
Git push status: ${{ env.push_status || 'unknown' }}
GitHub Run ID: ${{ github.run_id }}
GitHub Run Number: ${{ github.run_number }}
GitHub Actor: ${{ github.actor }}
Repository: ${{ github.repository }}
EOF
          
          # æ ¹æ®ä¸åŒçš„æ¨é€çŠ¶æ€æ·»åŠ ä¸åŒçš„ä¿¡æ¯
          case "${{ env.push_status }}" in
            "success")
              echo "[SUCCESS] Update completed successfully with standard push" >> update_status.txt
              ;;
            "success_with_force_lease")
              echo "[WARNING] Update completed with force-with-lease push" >> update_status.txt
              ;;
            "success_after_conflict_resolution")
              echo "[INFO] Update completed after resolving conflicts" >> update_status.txt
              ;;
            "success_after_ref_reset")
              echo "[WARNING] Update completed after reference reset due to 'cannot lock ref' error" >> update_status.txt
              ;;
            "failure_after_multiple_attempts")
              echo "[CRITICAL] All push attempts failed after multiple resolution strategies" >> update_status.txt
              echo "[ERROR] Manual intervention required to resolve repository inconsistencies" >> update_status.txt
              ;;
            "failure")
              echo "[ERROR] Update failed due to Git push conflicts or other errors" >> update_status.txt
              ;;
            "failure_api_update")
              echo "[ERROR] All update methods failed" >> update_status.txt
              echo "[CRITICAL] Manual intervention required" >> update_status.txt
              ;;
            "success_with_github_api")
              echo "[SUCCESS] Update completed using GitHub API" >> update_status.txt
              echo "[INFO] This was executed using the mutual exclusion fallback strategy" >> update_status.txt
              ;;
            "nothing_to_push")
              echo "[INFO] No changes detected, nothing to push" >> update_status.txt
              ;;
            *)
              echo "[WARNING] Unknown push status" >> update_status.txt
              ;;
          esac
          
          echo "Update completed at: $(date +'%Y-%m-%d %H:%M:%S')" >> update_status.txt
          
          # æ£€æŸ¥æ˜¯å¦æœ‰é”™è¯¯æ—¥å¿—ç›®å½•å¹¶æ·»åŠ ä¿¡æ¯
          if [ -d "git_debug_logs" ]; then
            echo "\nDebug information available in git_debug_logs/ directory" >> update_status.txt
            echo "Debug logs: $(ls -la git_debug_logs/)" >> update_status.txt
          fi
          
          # æ›´æ–°çŠ¶æ€æ–‡ä»¶
          git add update_status.txt
          if git diff --staged --quiet; then
            echo "No changes to status file to commit"
          else
            echo "Committing updated status file..."
            git commit --amend --no-edit && echo "Status file committed successfully"
            # å°è¯•æ¨é€çŠ¶æ€æ›´æ–°ï¼Œä½†ä¸ä¸­æ–­æµç¨‹
            git push --force-with-lease origin HEAD:main || {
              echo "Failed to update status file in remote, but continuing workflow"
              # å¦‚æœæ¨é€å¤±è´¥ï¼Œè‡³å°‘ä¿å­˜åˆ°æœ¬åœ°
              cp update_status.txt status_backup.txt
              echo "Status file backed up to status_backup.txt"
            }
          fi
          
          # æ˜¾ç¤ºæœ€ç»ˆçŠ¶æ€
          echo "\n=== FINAL STATUS ==="
          cat update_status.txt
          echo "====================="
          
      - name: Upload comprehensive debugging artifacts
        uses: actions/upload-artifact@v3
        with:
          name: workflow-debug-logs-${{ github.run_id }}
          path: |
            script_output.log
            update_status.txt
            status_backup.txt
            tzydayauto.txt
            git_config.log
            git_debug_logs/
          retention-days: 14
          if-no-files-found: warn
          
      - name: Send detailed success notification
        if: success()
        run: |
          echo "âœ… TVZY Daily Update completed successfully!"
          echo "ğŸ“Š Execution Summary:"
          echo "- Push status: ${{ env.push_status }}"
          echo "- Run ID: ${{ github.run_id }}"
          echo "- Repository: ${{ github.repository }}"
          echo "- Branch: ${{ github.ref }}"
          echo "- Commit: ${{ github.sha }}"
          echo "- Logs available as workflow artifacts (retention: 14 days)"
          
          # æ ¹æ®ä¸åŒçš„æˆåŠŸçŠ¶æ€æ˜¾ç¤ºä¸åŒçš„æç¤º
          case "${{ env.push_status }}" in
            "success")
              echo "âœ… Standard push completed successfully"
              ;;
            "success_with_force_lease")
              echo "âš ï¸  Force-with-lease push was required"
              echo "   This indicates potential branch divergence that was safely resolved"
              ;;
            "success_after_conflict_resolution")
              echo "ğŸ”„ Conflict resolution was successful"
              echo "   Local changes were merged with remote updates"
              ;;
            "success_after_ref_reset")
              echo "ğŸ”„ Repository reference was reset to resolve 'cannot lock ref' error"
              echo "   This is an expected recovery mechanism for reference inconsistencies"
              ;;
          esac
          
          echo "ğŸ“š Troubleshooting Resources:"
          echo "- View complete logs in the 'Artifacts' section"
          echo "- Check update_status.txt for detailed operation results"
          
      - name: Send detailed failure notification
        if: failure()
        run: |
          echo "âŒ TVZY Daily Update failed!"
          echo "ğŸ“Š Error Summary:"
          echo "- Push status: ${{ env.push_status || 'unknown' }}"
          echo "- Run ID: ${{ github.run_id }}"
          echo "- Repository: ${{ github.repository }}"
          echo "- Branch: ${{ github.ref }}"
          
          # æ ¹æ®ä¸åŒçš„å¤±è´¥çŠ¶æ€æä¾›é’ˆå¯¹æ€§çš„è§£å†³å»ºè®®
          case "${{ env.push_status }}" in
            "failure_after_multiple_attempts")
              echo "ğŸ”´ CRITICAL: Multiple resolution attempts failed"
              echo "   Recommendation: Repository might have serious reference inconsistencies"
              echo "   Resolution Steps:"
              echo "   1. Clone a fresh copy of the repository"
              echo "   2. Run the update script locally"
              echo "   3. Push changes manually with proper authentication"
              echo "   4. Check for any concurrent workflows running on the same branch"
              ;;
            "failure")
              echo "ğŸ”´ General Git push failure occurred"
              echo "   Recommendation: Check for concurrent updates or permission issues"
              echo "   Resolution Steps:"
              echo "   1. Check if multiple workflows are running simultaneously"
              echo "   2. Verify GITHUB_TOKEN has sufficient permissions"
              echo "   3. Ensure branch protection rules allow force-with-lease pushes if needed"
              ;;
            *)
              echo "ğŸ”´ Unknown failure reason"
              echo "   Recommendation: Examine detailed logs for root cause"
              ;;
          esac
          
          echo "ğŸ“š Detailed Debugging Information:"
          echo "- All debug logs are available as workflow artifacts"
          echo "- Check git_debug_logs/ directory for detailed Git operations history"
          echo "- Review error_diagnostics.log for specific Git reference errors"
          
          echo "ğŸ”„ Next Steps:"
          echo "- If this persists, consider scheduling workflow runs at staggered times"
          echo "- For 'cannot lock ref' errors, check if branch protection rules are too restrictive"
          echo "- Consider implementing a mutex mechanism if running concurrent updates"
