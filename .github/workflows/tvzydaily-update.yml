name: TVZY Daily Update

on:
  # æ¯å¤©å®šæ—¶è¿è¡Œ
  schedule:
    - cron: '0 0 * * *'  # æ¯å¤©UTC 0ç‚¹è¿è¡Œ
  # å…è®¸æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      logLevel:
        description: 'Log level'
        required: true
        default: 'info'

jobs:
  update-tv-channels:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # ç¡®ä¿æœ‰å†™æƒé™
    steps:
      # ç¬¬ä¸€æ­¥ï¼šæ£€å‡ºä»£ç ï¼ˆä»…ç”¨äºè·å–è„šæœ¬ï¼Œä¸ä½¿ç”¨gitæ¨é€ï¼‰
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          ref: main
      
      # ç¬¬äºŒæ­¥ï¼šè®¾ç½®Pythonç¯å¢ƒ
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
      
      # ç¬¬ä¸‰æ­¥ï¼šå®‰è£…ä¾èµ–
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests schedule
          # å®‰è£…jqå·¥å…·ç”¨äºå®‰å…¨å¤„ç†JSONæ•°æ®
          sudo apt-get update && sudo apt-get install -y jq
      
      # ç¬¬å››æ­¥ï¼šç”Ÿæˆæ–‡ä»¶å¹¶ç›´æ¥ä½¿ç”¨GitHub APIä¸Šä¼ ï¼ˆå®Œå…¨é¿å…gitæ“ä½œï¼‰
      - name: Generate and upload file using GitHub API
        run: |
          echo "ğŸ”„ å¼€å§‹ç”Ÿæˆç›´æ’­æºæ–‡ä»¶..."
          
          # è¿è¡Œè„šæœ¬ç”Ÿæˆæ–‡ä»¶
          python tvzydaily.py
          
          # éªŒè¯æ–‡ä»¶ç”Ÿæˆ
          if [ ! -f "tzydauto.txt" ]; then
            echo "âŒ é”™è¯¯: tzydauto.txt æ–‡ä»¶æœªç”Ÿæˆ"
            exit 1
          fi
          
          echo "âœ… æ–‡ä»¶ç”ŸæˆæˆåŠŸï¼Œå†…å®¹ç»Ÿè®¡ï¼š"
          wc -l tzydauto.txt
          head -n 5 tzydauto.txt
          
          # ç›´æ¥ä½¿ç”¨curlå’ŒGitHub APIä¸Šä¼ æ–‡ä»¶ï¼Œä¸ä½¿ç”¨ä»»ä½•gitå‘½ä»¤
          echo "ğŸ”„ ä½¿ç”¨GitHub APIç›´æ¥ä¸Šä¼ æ–‡ä»¶..."
          
          # ç¼–ç æ–‡ä»¶å†…å®¹ä¸ºbase64
          CONTENT=$(base64 -w 0 tzydauto.txt)
          
          # åˆ›å»ºæ—¥æœŸæ—¶é—´æˆ³
          TIMESTAMP=$(date +'%Y-%m-%d %H:%M:%S')
          
          # æ„å»ºJSONæ•°æ®ï¼Œä½¿ç”¨æ›´å®‰å…¨çš„æ–¹å¼å¤„ç†ç‰¹æ®Šå­—ç¬¦
          # å…ˆå°†base64å†…å®¹å†™å…¥ä¸´æ—¶æ–‡ä»¶ï¼Œç„¶åè¯»å–ä»¥é¿å…shellè½¬ä¹‰é—®é¢˜
          echo "$CONTENT" > content_base64.txt
          
          # ä½¿ç”¨jqæ„å»ºæœ‰æ•ˆçš„JSONï¼Œé¿å…shellå­—ç¬¦ä¸²è½¬ä¹‰é—®é¢˜
          JSON_DATA=$(jq -n --arg message "Auto-update IPTV files - $TIMESTAMP" \
                       --arg content "$(cat content_base64.txt)" \
                       --arg branch "main" \
                       '{message: $message, content: $content, branch: $branch}')
          
          # ä½¿ç”¨curlè°ƒç”¨GitHub API
          RESPONSE=$(curl -X PUT \
              -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
              -H "Accept: application/vnd.github+json" \
              -H "Content-Type: application/json" \
              https://api.github.com/repos/wangchongzhq/zhby/contents/tzydauto.txt \
              --data-binary "$JSON_DATA")
          
          # æ£€æŸ¥å“åº”
          if [[ $? -eq 0 ]]; then
            # æ£€æŸ¥æ˜¯å¦åŒ…å«é”™è¯¯ä¿¡æ¯
            if echo "$RESPONSE" | grep -q '"message":"Not Found"'; then
              echo "âŒ é”™è¯¯: ä»“åº“è·¯å¾„æˆ–æ–‡ä»¶è·¯å¾„ä¸æ­£ç¡®"
              echo "å“åº”å†…å®¹: $RESPONSE"
              exit 1
            elif echo "$RESPONSE" | grep -q '"message":"Bad credentials"'; then
              echo "âŒ é”™è¯¯: GitHub Token æ— æ•ˆæˆ–æƒé™ä¸è¶³"
              echo "å“åº”å†…å®¹: $RESPONSE"
              exit 1
            else
              echo "âœ… âœ… âœ… æˆåŠŸä½¿ç”¨GitHub APIæ›´æ–°æ–‡ä»¶ï¼"
              echo "å“åº”å†…å®¹: $RESPONSE"
            fi
          else
            echo "âŒ GitHub APIè¯·æ±‚å¤±è´¥"
            echo "å“åº”å†…å®¹: $RESPONSE"
            exit 1
          fi
          
          echo "ğŸ‰ æ›´æ–°å®Œæˆï¼"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
