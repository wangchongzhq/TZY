name: ç”µè§†ç›´æ’­çº¿è·¯è‡ªåŠ¨æ›´æ–°å·¥ä½œæµï¼ˆæ— git pushç‰ˆæœ¬ï¼‰

on:
  schedule:
    - cron: '0 8 * * *'  # æ¯å¤©æ—©ä¸Š8ç‚¹è¿è¡Œ
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  update-tv-channels:
    runs-on: ubuntu-latest
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v3
        with:
          fetch-depth: 0  # è·å–å®Œæ•´å†å²è®°å½•
          ref: ${{ github.ref }}
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: ç¯å¢ƒå‡†å¤‡
        run: |
          echo "å‡†å¤‡Pythonç¯å¢ƒå’Œä¾èµ–å®‰è£…"
          echo "å·¥ä½œç›®å½•: $(pwd)"
          ls -la
      
      - name: åŒæ­¥è¿œç¨‹ä»“åº“æ›´æ”¹
        run: |
          echo "ğŸ”„ åŒæ­¥è¿œç¨‹ä»“åº“æ›´æ”¹..."
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git checkout ${{ github.ref_name }}
          git pull origin ${{ github.ref_name }} --rebase || {
            echo "âš ï¸  æ‹‰å–å¤±è´¥ï¼Œå°è¯•ä½¿ç”¨--allow-unrelated-histories..."
            git pull origin ${{ github.ref_name }} --rebase --allow-unrelated-histories || {
              echo "âŒ æ— æ³•æ‹‰å–è¿œç¨‹æ›´æ”¹ï¼Œå°†ä½¿ç”¨æœ¬åœ°ç‰ˆæœ¬ç»§ç»­"
            }
          }
          git status
      
      - name: è®¾ç½®Pythonç¯å¢ƒ
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
          cache: 'pip'
      
      - name: å®‰è£…Pythonä¾èµ–
        run: |
          python -m pip install --upgrade pip
          pip install requests
          echo "å·²å®‰è£…ä¾èµ–: requests"
      
      - name: è¿è¡Œç”µè§†ç›´æ’­çº¿è·¯æ”¶é›†è„šæœ¬
        run: |
          echo "å¼€å§‹æ‰§è¡Œtvzydaily.pyè„šæœ¬..."
          python tvzydaily.py
          echo "è„šæœ¬æ‰§è¡Œå®Œæˆï¼Œæ£€æŸ¥è¾“å‡ºæ–‡ä»¶"
          if [ -f "tzydauto.txt" ]; then
            echo "è¾“å‡ºæ–‡ä»¶ç”ŸæˆæˆåŠŸ: $(wc -l tzydauto.txt) è¡Œ"
            head -10 tzydauto.txt
          else
            echo "é”™è¯¯: è¾“å‡ºæ–‡ä»¶æœªç”Ÿæˆ"
            exit 1
          fi
      
      - name: ä½¿ç”¨GitHub APIä¸Šä¼ æ›´æ–°çš„æ–‡ä»¶ï¼ˆæ— git pushï¼‰
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO_OWNER: ${{ github.repository_owner }}
          REPO_NAME: ${{ github.event.repository.name }}
          BRANCH: main
          GITHUB_API_VERSION: "2022-11-28"
          USER_AGENT: "GitHub-Actions-Tvzy-Update-Script"
        run: |
          # å®‰å…¨ç¯å¢ƒå˜é‡éªŒè¯
          if [ -z "$GITHUB_TOKEN" ]; then
            echo "âŒ é”™è¯¯: GITHUB_TOKEN ç¯å¢ƒå˜é‡æœªè®¾ç½®"
            exit 1
          fi
          
          if [ -z "$REPO_OWNER" ] || [ -z "$REPO_NAME" ]; then
            echo "âŒ é”™è¯¯: ä»“åº“ä¿¡æ¯ç¯å¢ƒå˜é‡æœªæ­£ç¡®è®¾ç½®"
            exit 1
          fi
          
          # å®šä¹‰å‡½æ•°ï¼šè·å–æ–‡ä»¶çš„å½“å‰SHAï¼ˆå¸¦é‡è¯•æœºåˆ¶ï¼‰
          get_current_sha() {
            local file_path=$1
            local max_retries=3
            local retry_count=0
            local sha
            local base_url="https://api.github.com"
            local endpoint="/repos/$REPO_OWNER/$REPO_NAME/contents/$file_path?ref=$BRANCH"
            
            echo "ğŸ“ å°è¯•è·å–æ–‡ä»¶ $file_path çš„å½“å‰SHA..."
            
            while [ $retry_count -lt $max_retries ]; do
              retry_count=$((retry_count + 1))
              echo "ğŸ”„ SHAè·å–å°è¯• $retry_count/$max_retries..."
              
              # ä½¿ç”¨æ›´å¥å£®çš„curlå‚æ•°å’Œå…¨é¢çš„é”™è¯¯å¤„ç†
              local response=$(curl -s -w "\n%{http_code}" \
                --max-time 15 \
                --connect-timeout 5 \
                --retry 1 \
                -H "Authorization: token $GITHUB_TOKEN" \
                -H "Accept: application/vnd.github+json" \
                -H "X-GitHub-Api-Version: $GITHUB_API_VERSION" \
                -H "User-Agent: $USER_AGENT" \
                "$base_url$endpoint")
              
              # æå–HTTPçŠ¶æ€ç å’Œå“åº”ä½“
              local http_code=$(echo "$response" | tail -n 1)
              local response_body=$(echo "$response" | head -n -1)
              
              echo "ğŸ“Š SHAè¯·æ±‚HTTPçŠ¶æ€ç : $http_code"
              
              # å¤„ç†ä¸åŒçš„HTTPçŠ¶æ€ç 
              if [ "$http_code" -eq 200 ]; then
                # æ–‡ä»¶å­˜åœ¨ï¼Œæå–SHA
                if echo "$response_body" | grep -q '"sha":"'; then
                  sha=$(echo "$response_body" | grep -o '"sha":"[^"]*"' | cut -d':' -f2 | tr -d '"')
                  echo "âœ… æˆåŠŸè·å–æ–‡ä»¶SHA: $sha"
                  echo "$sha"
                  return 0
                else
                  echo "âš ï¸  å“åº”ä¸­æœªæ‰¾åˆ°æœ‰æ•ˆSHAå­—æ®µ"
                  echo "å“åº”é¢„è§ˆ: $(echo "$response_body" | head -n 5)"
                fi
              elif [ "$http_code" -eq 404 ]; then
                echo "â„¹ï¸  æ–‡ä»¶ $file_path ä¸å­˜åœ¨ï¼Œå°†åˆ›å»ºæ–°æ–‡ä»¶"
                echo ""
                return 0  # 404æ˜¯å¯æ¥å—çš„ï¼Œè¿”å›ç©ºSHAä»¥åˆ›å»ºæ–°æ–‡ä»¶
              elif [ "$http_code" -eq 401 ]; then
                echo "âŒ æˆæƒå¤±è´¥ï¼Œè¯·æ£€æŸ¥GITHUB_TOKENæƒé™"
                echo "å“åº”é¢„è§ˆ: $(echo "$response_body" | head -n 3)"
                return 1
              elif [ "$http_code" -eq 403 ]; then
                echo "âŒ APIé€Ÿç‡é™åˆ¶æˆ–æƒé™ä¸è¶³ï¼ˆ403ï¼‰"
                local reset_time=$(echo "$response_body" | grep -o '"reset":"[^"]*"' | cut -d':' -f2- | tr -d '"')
                if [ -n "$reset_time" ]; then
                  echo "ğŸ“… é€Ÿç‡é™åˆ¶é‡ç½®æ—¶é—´: $reset_time"
                fi
                # ç«‹å³é‡è¯•
              elif [ "$http_code" -ge 500 ] && [ "$http_code" -lt 600 ]; then
                echo "âš ï¸  GitHubæœåŠ¡å™¨é”™è¯¯ ($http_code)ï¼Œå°†é‡è¯•..."
              else
                echo "âŒ SHAè·å–å¤±è´¥ï¼ŒHTTPçŠ¶æ€ç : $http_code"
                echo "å“åº”é¢„è§ˆ: $(echo "$response_body" | head -n 3)"
              fi
              
              # å¦‚æœè¿˜æœ‰é‡è¯•æ¬¡æ•°ï¼Œç­‰å¾…åé‡è¯•
              if [ $retry_count -lt $max_retries ]; then
                local wait_time=$((retry_count * 3))  # çº¿æ€§é€€é¿
                echo "â±ï¸  ç­‰å¾… ${wait_time}ç§’åé‡è¯•..."
                sleep $wait_time
              fi
            done
            
            echo "âš ï¸  æ‰€æœ‰SHAè·å–å°è¯•å‡å¤±è´¥ï¼Œå°†å°è¯•ä½œä¸ºæ–°æ–‡ä»¶ä¸Šä¼ "
            echo ""
            return 0
          }
          
          # å®šä¹‰å‡½æ•°ï¼šä½¿ç”¨æŒ‡æ•°é€€é¿ç­–ç•¥ä¸Šä¼ æ–‡ä»¶
          upload_with_retry() {
            local file_path=$1
            local max_retries=5
            local retry_count=0
            local base_delay=2
            local base_url="https://api.github.com"
            local endpoint="/repos/$REPO_OWNER/$REPO_NAME/contents/$file_path"
            local timestamp=$(date +'%Y-%m-%d %H:%M:%S')
            
            echo "ğŸ“¤ å¼€å§‹ä¸Šä¼ æ–‡ä»¶ $file_path..."
            
            # éªŒè¯æ–‡ä»¶æ˜¯å¦å­˜åœ¨ä¸”éç©º
            if [ ! -f "$file_path" ]; then
              echo "âŒ é”™è¯¯: æ–‡ä»¶ $file_path ä¸å­˜åœ¨"
              return 1
            fi
            
            if [ ! -s "$file_path" ]; then
              echo "âŒ é”™è¯¯: æ–‡ä»¶ $file_path ä¸ºç©º"
              return 1
            fi
            
            # æ£€æŸ¥æ–‡ä»¶æƒé™
            if [ ! -r "$file_path" ]; then
              echo "âŒ é”™è¯¯: æ–‡ä»¶ $file_path æ— æ³•è¯»å–"
              return 1
            fi
            
            # æ–‡ä»¶å¤§å°æ£€æŸ¥
            local file_size=$(wc -c < "$file_path")
            echo "ğŸ“Š æ–‡ä»¶å¤§å°: $file_size å­—èŠ‚"
            
            # ç”Ÿæˆbase64ç¼–ç å†…å®¹ï¼Œä½¿ç”¨æ›´å®‰å…¨çš„æ–¹å¼å¤„ç†
            local content_base64
            echo "ğŸ”’ ç¼–ç æ–‡ä»¶å†…å®¹ä¸ºbase64..."
            content_base64=$(base64 -w 0 "$file_path" 2>/dev/null)
            
            # éªŒè¯base64å†…å®¹
            if [ -z "$content_base64" ]; then
              echo "âŒ é”™è¯¯: æ–‡ä»¶ $file_path æ— æ³•ç¼–ç ä¸ºbase64"
              return 1
            fi
            
            # éªŒè¯base64ç¼–ç çš„åŸºæœ¬æœ‰æ•ˆæ€§
            if ! echo "$content_base64" | grep -q '^[A-Za-z0-9+/=]\+$'; then
              echo "âš ï¸  è­¦å‘Š: base64ç¼–ç å¯èƒ½åŒ…å«ç‰¹æ®Šå­—ç¬¦ï¼Œè¿›è¡Œé¢å¤–å¤„ç†..."
              # å°è¯•å†æ¬¡ç¼–ç ï¼Œå¯èƒ½åŒ…å«ç‰¹æ®Šå­—ç¬¦çš„æƒ…å†µ
              content_base64=$(cat "$file_path" | base64 -w 0)
            fi
            
            # è®°å½•base64å†…å®¹é•¿åº¦ï¼ˆä¸æ‰“å°å®é™…å†…å®¹ï¼‰
            local base64_length=${#content_base64}
            echo "ğŸ“ base64å†…å®¹é•¿åº¦: $base64_length å­—ç¬¦"
            
            # é‡è¯•å¾ªç¯
            while [ $retry_count -lt $max_retries ]; do
              retry_count=$((retry_count + 1))
              echo "ğŸ”„ ä¸Šä¼ å°è¯• $retry_count/$max_retries..."
              
              # æ¯æ¬¡é‡è¯•éƒ½è·å–æœ€æ–°çš„SHAï¼Œä»¥å¤„ç†å¯èƒ½çš„å¹¶å‘æ›´æ–°
              local current_sha=$(get_current_sha "$file_path")
              
              # æ„å»ºæäº¤æ¶ˆæ¯
              local commit_message="è‡ªåŠ¨æ›´æ–°: $file_path ($timestamp)"
              
              # æ„å»ºJSONæ•°æ®ï¼Œä½¿ç”¨æ›´å®‰å…¨çš„æ ¼å¼
              local json_data
              if [ -n "$current_sha" ]; then
                echo "ğŸ“ æ›´æ–°ç°æœ‰æ–‡ä»¶ï¼Œä½¿ç”¨SHA: $current_sha"
                # ä½¿ç”¨catå’Œhere-documentæ„å»ºJSONï¼Œé¿å…å¼•å·åµŒå¥—é—®é¢˜
                json_data=$(cat <<EOF
{"message":"$commit_message","content":"$content_base64","sha":"$current_sha","branch":"$BRANCH"}
EOF
)
              else
                echo "ğŸ“ åˆ›å»ºæ–°æ–‡ä»¶"
                # ä½¿ç”¨catå’Œhere-documentæ„å»ºJSONï¼Œé¿å…å¼•å·åµŒå¥—é—®é¢˜
                json_data=$(cat <<EOF
{"message":"$commit_message","content":"$content_base64","branch":"$BRANCH"}
EOF
)
              fi
              
              # éªŒè¯JSONæ ¼å¼çš„åŸºæœ¬æœ‰æ•ˆæ€§
              if ! echo "$json_data" | grep -q '^{"message":"'; then
                echo "âŒ JSONæ•°æ®æ ¼å¼é”™è¯¯ï¼Œé‡æ–°ç”Ÿæˆ..."
                continue
              fi
              
              # ä½¿ç”¨curlè°ƒç”¨GitHub APIï¼Œå¢å¼ºç½‘ç»œå‚æ•°
              echo "ğŸ”Œ å‘é€APIè¯·æ±‚åˆ°GitHub..."
              local response=$(curl -s -w "\n%{http_code}" \
                -X PUT \
                --max-time 60 \
                --retry 2 \
                --retry-delay 3 \
                --connect-timeout 10 \
                --keepalive-time 60 \
                -H "Authorization: token $GITHUB_TOKEN" \
                -H "Accept: application/vnd.github+json" \
                -H "Content-Type: application/json" \
                -H "X-GitHub-Api-Version: $GITHUB_API_VERSION" \
                -H "User-Agent: $USER_AGENT" \
                "$base_url$endpoint" \
                --data "$json_data")
              
              # è§£æHTTPçŠ¶æ€ç å’Œå“åº”ä½“
              local http_code=$(echo "$response" | tail -n 1)
              local response_body=$(echo "$response" | head -n -1)
              
              echo "ğŸ“Š APIå“åº”çŠ¶æ€ç : $http_code"
              
              # æ£€æŸ¥æˆåŠŸæ¡ä»¶
              if [ "$http_code" -eq 200 ] || [ "$http_code" -eq 201 ]; then
                # éªŒè¯å“åº”å†…å®¹æ˜¯å¦åŒ…å«é¢„æœŸå­—æ®µ
                if echo "$response_body" | grep -q -E '"sha":"|"commit":|"content":'; then
                  echo "âœ… âœ… âœ… æˆåŠŸä½¿ç”¨GitHub APIæ›´æ–°æ–‡ä»¶ï¼"
                  
                  # è·å–æäº¤URLï¼ˆå¦‚æœæœ‰ï¼‰
                  local commit_url=$(echo "$response_body" | grep -o '"html_url":"[^"]*"' | cut -d':' -f2- | tr -d '"')
                  if [ -n "$commit_url" ]; then
                    echo "ğŸ”— æäº¤URL: $commit_url"
                  fi
                  
                  return 0
                else
                  echo "âš ï¸  å“åº”ä¸­æœªæ‰¾åˆ°é¢„æœŸå­—æ®µï¼Œä½†HTTPçŠ¶æ€ç ä¸ºæˆåŠŸ"
                  echo "å“åº”é¢„è§ˆ: $(echo "$response_body" | head -n 3)"
                  return 0  # çŠ¶æ€ç æˆåŠŸæ—¶è®¤ä¸ºä¸Šä¼ æˆåŠŸ
                fi
              fi
              
              # è¯¦ç»†é”™è¯¯åˆ†æ
              local error_message=$(echo "$response_body" | grep -o '"message":"[^"]*"' | cut -d':' -f2 | tr -d '"' || echo "æœªçŸ¥é”™è¯¯")
              echo "âŒ ä¸Šä¼ å¤±è´¥ï¼Œé”™è¯¯ä¿¡æ¯: $error_message"
              
              # å¤„ç†ç‰¹å®šé”™è¯¯ç±»å‹
              if [ "$http_code" -eq 409 ] || echo "$error_message" | grep -q -E 'sha|conflict'; then
                echo "ğŸ”„ æ£€æµ‹åˆ°ç‰ˆæœ¬å†²çªæˆ–SHAæ— æ•ˆï¼Œå°†é‡æ–°è·å–æœ€æ–°SHA..."
                current_sha=""  # å¼ºåˆ¶ä¸‹æ¬¡è·å–æ–°SHA
                continue  # ç«‹å³é‡è¯•ï¼Œä¸ç­‰å¾…
              elif [ "$http_code" -eq 401 ]; then
                echo "âŒ æˆæƒå¤±è´¥ï¼Œä»¤ç‰Œå¯èƒ½æ— æ•ˆæˆ–æƒé™ä¸è¶³"
                echo "å“åº”é¢„è§ˆ: $(echo "$response_body" | head -n 3)"
                return 1  # ä¸å†é‡è¯•æˆæƒé”™è¯¯
              elif [ "$http_code" -eq 403 ]; then
                echo "âš ï¸  APIé€Ÿç‡é™åˆ¶æˆ–æƒé™ä¸è¶³ï¼ˆ403ï¼‰"
                local reset_time=$(echo "$response_body" | grep -o '"reset":"[^"]*"' | cut -d':' -f2- | tr -d '"')
                if [ -n "$reset_time" ]; then
                  echo "ğŸ“… é€Ÿç‡é™åˆ¶é‡ç½®æ—¶é—´: $reset_time"
                fi
                # å¢åŠ ç­‰å¾…æ—¶é—´
              elif [ "$http_code" -ge 500 ] && [ "$http_code" -lt 600 ]; then
                echo "âš ï¸  GitHubæœåŠ¡å™¨é”™è¯¯ ($http_code)ï¼Œå°†é‡è¯•..."
                # æœåŠ¡å™¨é”™è¯¯éœ€è¦æ›´æ¿€è¿›çš„é‡è¯•
              elif [ "$http_code" -eq 404 ]; then
                echo "âš ï¸  èµ„æºä¸å­˜åœ¨ï¼ˆ404ï¼‰ï¼Œå°†å°è¯•ä½œä¸ºæ–°æ–‡ä»¶åˆ›å»º"
                current_sha=""  # å¼ºåˆ¶åˆ›å»ºæ–°æ–‡ä»¶
                continue  # ç«‹å³é‡è¯•
              else
                echo "âŒ æœªçŸ¥é”™è¯¯ï¼ŒHTTPçŠ¶æ€ç : $http_code"
              fi
              
              # æŒ‡æ•°é€€é¿ç­–ç•¥
              if [ $retry_count -lt $max_retries ]; then
                local delay=$((base_delay * (2 ** (retry_count - 1))))
                # å¢åŠ éšæœºæŠ–åŠ¨ï¼ˆÂ±20%ï¼‰ä»¥é¿å…é‡è¯•é£æš´
                local jitter=$((RANDOM % (delay / 5) + 1))
                if [ $((RANDOM % 2)) -eq 0 ]; then
                  delay=$((delay + jitter))
                else
                  delay=$((delay - jitter))
                fi
                
                # ç¡®ä¿å»¶è¿Ÿè‡³å°‘ä¸º1ç§’
                if [ $delay -lt 1 ]; then delay=1; fi
                
                echo "â±ï¸  $delayç§’åé‡è¯•..."
                sleep $delay
              fi
            done
            
            echo "âŒ æ‰€æœ‰ä¸Šä¼ å°è¯•å‡å¤±è´¥"
            echo "ğŸ“‹ æœ€åå“åº”é¢„è§ˆ: $(echo "$response_body" | head -n 5)"
            return 1
          }
          
          # ä¸Šä¼ ä¸»è¦è¾“å‡ºæ–‡ä»¶
          echo "ğŸš€ å¼€å§‹ä½¿ç”¨GitHub APIä¸Šä¼ æ–‡ä»¶..."
          upload_with_retry "tzydauto.txt"
          upload_status=$?
          
          # ä¸Šä¼ è°ƒè¯•æ—¥å¿—ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
          if [ -f "debug_output.txt" ]; then
            echo "ğŸ“‹ ä¸Šä¼ è°ƒè¯•æ—¥å¿—æ–‡ä»¶..."
            upload_with_retry "debug_output.txt"
          fi
          
          # ä¸Šä¼ è„šæœ¬æ—¥å¿—ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
          if [ -f "tvzy.log" ]; then
            echo "ğŸ“Š ä¸Šä¼ è„šæœ¬æ—¥å¿—æ–‡ä»¶..."
            upload_with_retry "tvzy.log"
          fi
          
          # è¿”å›ä¸Šä¼ çŠ¶æ€
          if [ $upload_status -eq 0 ]; then
            echo "ğŸ‰ æ‰€æœ‰æ–‡ä»¶ä¸Šä¼ æˆåŠŸï¼"
            # ç”Ÿæˆè¯¦ç»†æŠ¥å‘Š
            echo "ğŸ“‹ ä¸Šä¼ æŠ¥å‘Š:"
            echo "- ä¸»æ–‡ä»¶: tzydauto.txt (æˆåŠŸ)"
            if [ -f "debug_output.txt" ]; then echo "- æ—¥å¿—æ–‡ä»¶: debug_output.txt (å°è¯•ä¸Šä¼ )"; fi
            if [ -f "tvzy.log" ]; then echo "- æ—¥å¿—æ–‡ä»¶: tvzy.log (å°è¯•ä¸Šä¼ )"; fi
            echo "â° å®Œæˆæ—¶é—´: $(date +'%Y-%m-%d %H:%M:%S')"
            exit 0
          else
            echo "âŒ é”™è¯¯: æ–‡ä»¶ä¸Šä¼ å¤±è´¥"
            echo "ğŸ“‹ è¯·æ£€æŸ¥GitHub APIé…ç½®å’Œæ–‡ä»¶æƒé™"
            exit 1
          fi
      
      - name: å‘é€æˆåŠŸé€šçŸ¥
        if: success()
        run: |
          echo "ğŸ‰ ç”µè§†ç›´æ’­çº¿è·¯è‡ªåŠ¨æ›´æ–°æˆåŠŸï¼"
          echo "ğŸ“ å·²æ›´æ–°æ–‡ä»¶: tzydauto.txt"
          echo "ğŸ“Š è¿è¡Œæ—¶é—´: $(date)"
      
      - name: å‘é€å¤±è´¥é€šçŸ¥
        if: failure()
        run: |
          echo "âŒ ç”µè§†ç›´æ’­çº¿è·¯è‡ªåŠ¨æ›´æ–°å¤±è´¥ï¼"
          echo "ğŸ“‹ è¯·æ£€æŸ¥å·¥ä½œæµæ—¥å¿—è·å–è¯¦ç»†é”™è¯¯ä¿¡æ¯"
          exit 1
