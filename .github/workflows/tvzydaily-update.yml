name: ç”µè§†ç›´æ’­çº¿è·¯è‡ªåŠ¨æ›´æ–°å·¥ä½œæµï¼ˆåŸºäºGitHub APIï¼‰

on:
  schedule:
    - cron: '0 8 * * *'  # æ¯å¤©æ—©ä¸Š8ç‚¹è¿è¡Œ
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  update-tv-channels:
    runs-on: ubuntu-latest
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v3
        with:
          fetch-depth: 1  # åªè·å–æœ€æ–°æäº¤ï¼Œå‡å°‘å¸¦å®½ä½¿ç”¨
          ref: ${{ github.ref }}
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: ç¯å¢ƒå‡†å¤‡
        run: |
          echo "å‡†å¤‡Pythonç¯å¢ƒå’Œä¾èµ–å®‰è£…"
          echo "å·¥ä½œç›®å½•: $(pwd)"
          ls -la
      
      - name: åˆå§‹åŒ–Gité…ç½®ï¼ˆæœ€å°åŒ–è®¾ç½®ï¼‰
        run: |
          echo "ğŸ”„ åˆå§‹åŒ–åŸºæœ¬Gité…ç½®..."
          
          # ä»…é…ç½®åŸºæœ¬ç”¨æˆ·ä¿¡æ¯ï¼Œä¸æ‰§è¡Œä»»ä½•æ¨é€ç›¸å…³æ“ä½œ
          git config --local user.name "github-actions[bot]"
          git config --local user.email "action@github.com"
          
          # æ˜¾ç¤ºåŸºæœ¬ä»“åº“ä¿¡æ¯ç”¨äºè°ƒè¯•
          echo "ğŸ“ ä»“åº“ä¿¡æ¯ï¼š"
          git remote -v
          echo "å½“å‰åˆ†æ”¯ï¼š"
          git branch
      
      - name: è®¾ç½®Pythonç¯å¢ƒ
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
          cache: 'pip'
      
      - name: å®‰è£…Pythonä¾èµ–
        run: |
          python -m pip install --upgrade pip
          pip install requests
          echo "å·²å®‰è£…ä¾èµ–: requests"
      
      - name: è¿è¡Œç”µè§†ç›´æ’­çº¿è·¯æ”¶é›†è„šæœ¬
        run: |
          echo "å¼€å§‹æ‰§è¡Œtvzydaily.pyè„šæœ¬..."
          python tvzydaily.py
          echo "è„šæœ¬æ‰§è¡Œå®Œæˆï¼Œæ£€æŸ¥è¾“å‡ºæ–‡ä»¶"
          if [ -f "tzydauto.txt" ]; then
            echo "è¾“å‡ºæ–‡ä»¶ç”ŸæˆæˆåŠŸ: $(wc -l tzydauto.txt) è¡Œ"
            head -10 tzydauto.txt
          else
            echo "é”™è¯¯: è¾“å‡ºæ–‡ä»¶æœªç”Ÿæˆ"
            exit 1
          fi
      
      - name: æ¸…ç†å·¥ä½œç›®å½•ï¼ˆç¡®ä¿è„šæœ¬è¿è¡Œç¯å¢ƒå¹²å‡€ï¼‰
        run: |
          echo "ğŸ§¹ æ¸…ç†å·¥ä½œç›®å½•ï¼Œç¡®ä¿è„šæœ¬è¿è¡Œç¯å¢ƒå¹²å‡€..."
          # åˆ é™¤å¯èƒ½å­˜åœ¨çš„æ—§è¾“å‡ºæ–‡ä»¶ï¼Œé¿å…å¹²æ‰°
          rm -f tzydauto.txt debug_output.txt tvzy.log
          echo "âœ… å·¥ä½œç›®å½•æ¸…ç†å®Œæˆ"
      
      - name: ä½¿ç”¨GitHub APIè¿›è¡Œæ–‡ä»¶æ›´æ–°ï¼ˆå®Œå…¨åŸºäºAPIçš„åŸå­æ“ä½œï¼‰
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO_OWNER: ${{ github.repository_owner }}
          REPO_NAME: ${{ github.event.repository.name }}
          BRANCH: main
          GITHUB_API_VERSION: "2022-11-28"
          USER_AGENT: "GitHub-Actions-Tvzy-Update-Script"
        run: |
          # å®‰å…¨ç¯å¢ƒå˜é‡éªŒè¯
          if [ -z "$GITHUB_TOKEN" ]; then
            echo "âŒ é”™è¯¯: GITHUB_TOKEN ç¯å¢ƒå˜é‡æœªè®¾ç½®"
            exit 1
          fi
          
          if [ -z "$REPO_OWNER" ] || [ -z "$REPO_NAME" ]; then
            echo "âŒ é”™è¯¯: ä»“åº“ä¿¡æ¯ç¯å¢ƒå˜é‡æœªæ­£ç¡®è®¾ç½®"
            exit 1
          fi
          
          # å®šä¹‰å‡½æ•°ï¼šè·å–æ–‡ä»¶çš„å½“å‰SHAï¼ˆå¸¦é‡è¯•æœºåˆ¶ï¼‰
          get_current_sha() {
            local file_path=$1
            local max_retries=3
            local retry_count=0
            local sha
            local base_url="https://api.github.com"
            local endpoint="/repos/$REPO_OWNER/$REPO_NAME/contents/$file_path?ref=$BRANCH"
            
            echo "ğŸ“ å°è¯•è·å–æ–‡ä»¶ $file_path çš„å½“å‰SHA..."
            
            while [ $retry_count -lt $max_retries ]; do
              retry_count=$((retry_count + 1))
              echo "ğŸ”„ SHAè·å–å°è¯• $retry_count/$max_retries..."
              
              # ä½¿ç”¨æ›´å¥å£®çš„curlå‚æ•°å’Œå…¨é¢çš„é”™è¯¯å¤„ç†
              local response=$(curl -s -w "\n%{http_code}" \
                --max-time 15 \
                --connect-timeout 5 \
                --retry 1 \
                -H "Authorization: token $GITHUB_TOKEN" \
                -H "Accept: application/vnd.github+json" \
                -H "X-GitHub-Api-Version: $GITHUB_API_VERSION" \
                -H "User-Agent: $USER_AGENT" \
                "$base_url$endpoint")
              
              # æå–HTTPçŠ¶æ€ç å’Œå“åº”ä½“
              local http_code=$(echo "$response" | tail -n 1)
              local response_body=$(echo "$response" | head -n -1)
              
              echo "ğŸ“Š SHAè¯·æ±‚HTTPçŠ¶æ€ç : $http_code"
              
              # å¤„ç†ä¸åŒçš„HTTPçŠ¶æ€ç 
              if [ "$http_code" -eq 200 ]; then
                # æ–‡ä»¶å­˜åœ¨ï¼Œæå–SHA
                if echo "$response_body" | grep -q '"sha":"'; then
                  sha=$(echo "$response_body" | grep -o '"sha":"[^"]*"' | cut -d':' -f2 | tr -d '"')
                  echo "âœ… æˆåŠŸè·å–æ–‡ä»¶SHA: $sha"
                  echo "$sha"
                  return 0
                else
                  echo "âš ï¸  å“åº”ä¸­æœªæ‰¾åˆ°æœ‰æ•ˆSHAå­—æ®µ"
                  echo "å“åº”é¢„è§ˆ: $(echo "$response_body" | head -n 5)"
                fi
              elif [ "$http_code" -eq 404 ]; then
                echo "â„¹ï¸  æ–‡ä»¶ $file_path ä¸å­˜åœ¨ï¼Œå°†åˆ›å»ºæ–°æ–‡ä»¶"
                echo ""
                return 0  # 404æ˜¯å¯æ¥å—çš„ï¼Œè¿”å›ç©ºSHAä»¥åˆ›å»ºæ–°æ–‡ä»¶
              elif [ "$http_code" -eq 401 ]; then
                echo "âŒ æˆæƒå¤±è´¥ï¼Œè¯·æ£€æŸ¥GITHUB_TOKENæƒé™"
                echo "å“åº”é¢„è§ˆ: $(echo "$response_body" | head -n 3)"
                return 1
              elif [ "$http_code" -eq 403 ]; then
                echo "âŒ APIé€Ÿç‡é™åˆ¶æˆ–æƒé™ä¸è¶³ï¼ˆ403ï¼‰"
                local reset_time=$(echo "$response_body" | grep -o '"reset":"[^"]*"' | cut -d':' -f2- | tr -d '"')
                if [ -n "$reset_time" ]; then
                  echo "ğŸ“… é€Ÿç‡é™åˆ¶é‡ç½®æ—¶é—´: $reset_time"
                fi
                # ç«‹å³é‡è¯•
              elif [ "$http_code" -ge 500 ] && [ "$http_code" -lt 600 ]; then
                echo "âš ï¸  GitHubæœåŠ¡å™¨é”™è¯¯ ($http_code)ï¼Œå°†é‡è¯•..."
              else
                echo "âŒ SHAè·å–å¤±è´¥ï¼ŒHTTPçŠ¶æ€ç : $http_code"
                echo "å“åº”é¢„è§ˆ: $(echo "$response_body" | head -n 3)"
              fi
              
              # å¦‚æœè¿˜æœ‰é‡è¯•æ¬¡æ•°ï¼Œç­‰å¾…åé‡è¯•
              if [ $retry_count -lt $max_retries ]; then
                local wait_time=$((retry_count * 3))  # çº¿æ€§é€€é¿
                echo "â±ï¸  ç­‰å¾… ${wait_time}ç§’åé‡è¯•..."
                sleep $wait_time
              fi
            done
            
            echo "âš ï¸  æ‰€æœ‰SHAè·å–å°è¯•å‡å¤±è´¥ï¼Œå°†å°è¯•ä½œä¸ºæ–°æ–‡ä»¶ä¸Šä¼ "
            echo ""
            return 0
          }
          
          # å®šä¹‰å‡½æ•°ï¼šä½¿ç”¨æŒ‡æ•°é€€é¿ç­–ç•¥ä¸Šä¼ æ–‡ä»¶
          upload_with_retry() {
            local file_path=$1
            local max_retries=5
            local retry_count=0
            local base_delay=2
            local base_url="https://api.github.com"
            local endpoint="/repos/$REPO_OWNER/$REPO_NAME/contents/$file_path"
            local timestamp=$(date +'%Y-%m-%d %H:%M:%S')
            
            echo "ğŸ“¤ å¼€å§‹ä¸Šä¼ æ–‡ä»¶ $file_path..."
            
            # éªŒè¯æ–‡ä»¶æ˜¯å¦å­˜åœ¨ä¸”éç©º
            if [ ! -f "$file_path" ]; then
              echo "âŒ é”™è¯¯: æ–‡ä»¶ $file_path ä¸å­˜åœ¨"
              return 1
            fi
            
            if [ ! -s "$file_path" ]; then
              echo "âŒ é”™è¯¯: æ–‡ä»¶ $file_path ä¸ºç©º"
              return 1
            fi
            
            # æ£€æŸ¥æ–‡ä»¶æƒé™
            if [ ! -r "$file_path" ]; then
              echo "âŒ é”™è¯¯: æ–‡ä»¶ $file_path æ— æ³•è¯»å–"
              return 1
            fi
            
            # æ–‡ä»¶å¤§å°æ£€æŸ¥
            local file_size=$(wc -c < "$file_path")
            echo "ğŸ“Š æ–‡ä»¶å¤§å°: $file_size å­—èŠ‚"
            
            # ç”Ÿæˆbase64ç¼–ç å†…å®¹ï¼Œä½¿ç”¨æ›´å®‰å…¨çš„æ–¹å¼å¤„ç†
            local content_base64
            echo "ğŸ”’ ç¼–ç æ–‡ä»¶å†…å®¹ä¸ºbase64..."
            content_base64=$(base64 -w 0 "$file_path" 2>/dev/null)
            
            # éªŒè¯base64å†…å®¹
            if [ -z "$content_base64" ]; then
              echo "âŒ é”™è¯¯: æ–‡ä»¶ $file_path æ— æ³•ç¼–ç ä¸ºbase64"
              return 1
            fi
            
            # éªŒè¯base64ç¼–ç çš„åŸºæœ¬æœ‰æ•ˆæ€§
            if ! echo "$content_base64" | grep -q '^[A-Za-z0-9+/=]\+$'; then
              echo "âš ï¸  è­¦å‘Š: base64ç¼–ç å¯èƒ½åŒ…å«ç‰¹æ®Šå­—ç¬¦ï¼Œè¿›è¡Œé¢å¤–å¤„ç†..."
              # å°è¯•å†æ¬¡ç¼–ç ï¼Œå¯èƒ½åŒ…å«ç‰¹æ®Šå­—ç¬¦çš„æƒ…å†µ
              content_base64=$(cat "$file_path" | base64 -w 0)
            fi
            
            # è®°å½•base64å†…å®¹é•¿åº¦ï¼ˆä¸æ‰“å°å®é™…å†…å®¹ï¼‰
            local base64_length=${#content_base64}
            echo "ğŸ“ base64å†…å®¹é•¿åº¦: $base64_length å­—ç¬¦"
            
            # é‡è¯•å¾ªç¯
            while [ $retry_count -lt $max_retries ]; do
              retry_count=$((retry_count + 1))
              echo "ğŸ”„ ä¸Šä¼ å°è¯• $retry_count/$max_retries..."
              
              # æ¯æ¬¡é‡è¯•éƒ½è·å–æœ€æ–°çš„SHAï¼Œä»¥å¤„ç†å¯èƒ½çš„å¹¶å‘æ›´æ–°
              local current_sha=$(get_current_sha "$file_path")
              
              # æ„å»ºæäº¤æ¶ˆæ¯
              local commit_message="è‡ªåŠ¨æ›´æ–°: $file_path ($timestamp)"
              
              # æ„å»ºJSONæ•°æ®ï¼Œä½¿ç”¨æ›´å®‰å…¨çš„æ ¼å¼
              local json_data
              if [ -n "$current_sha" ]; then
                echo "ğŸ“ æ›´æ–°ç°æœ‰æ–‡ä»¶ï¼Œä½¿ç”¨SHA: $current_sha"
                # ä½¿ç”¨catå’Œhere-documentæ„å»ºJSONï¼Œé¿å…å¼•å·åµŒå¥—é—®é¢˜
                json_data=$(cat <<'EOF'
{"message":"'"$commit_message"'","content":"'"$content_base64"'","sha":"'"$current_sha"'","branch":"'"$BRANCH"'"}
EOF
)
              else
                echo "ğŸ“ åˆ›å»ºæ–°æ–‡ä»¶"
                # ä½¿ç”¨catå’Œhere-documentæ„å»ºJSONï¼Œé¿å…å¼•å·åµŒå¥—é—®é¢˜
                json_data=$(cat <<'EOF'
{"message":"'"$commit_message"'","content":"'"$content_base64"'","branch":"'"$BRANCH"'"}
EOF
)
              fi
              
              # éªŒè¯JSONæ ¼å¼çš„åŸºæœ¬æœ‰æ•ˆæ€§
              if ! echo "$json_data" | grep -q '^{"message":"'; then
                echo "âŒ JSONæ•°æ®æ ¼å¼é”™è¯¯ï¼Œé‡æ–°ç”Ÿæˆ..."
                continue
              fi
              
              # ä½¿ç”¨curlè°ƒç”¨GitHub APIï¼Œå¢å¼ºç½‘ç»œå‚æ•°
              echo "ğŸ”Œ å‘é€APIè¯·æ±‚åˆ°GitHub..."
              local response=$(curl -s -w "\n%{http_code}" \
                -X PUT \
                --max-time 60 \
                --retry 2 \
                --retry-delay 3 \
                --connect-timeout 10 \
                --keepalive-time 60 \
                -H "Authorization: token $GITHUB_TOKEN" \
                -H "Accept: application/vnd.github+json" \
                -H "Content-Type: application/json" \
                -H "X-GitHub-Api-Version: $GITHUB_API_VERSION" \
                -H "User-Agent: $USER_AGENT" \
                "$base_url$endpoint" \
                --data "$json_data")
              
              # è§£æHTTPçŠ¶æ€ç å’Œå“åº”ä½“
              local http_code=$(echo "$response" | tail -n 1)
              local response_body=$(echo "$response" | head -n -1)
              
              echo "ğŸ“Š APIå“åº”çŠ¶æ€ç : $http_code"
              
              # æ£€æŸ¥æˆåŠŸæ¡ä»¶
              if [ "$http_code" -eq 200 ] || [ "$http_code" -eq 201 ]; then
                # éªŒè¯å“åº”å†…å®¹æ˜¯å¦åŒ…å«é¢„æœŸå­—æ®µ
                if echo "$response_body" | grep -q -E '"sha":"|"commit":|"content":'; then
                  echo "âœ… âœ… âœ… æˆåŠŸä½¿ç”¨GitHub APIæ›´æ–°æ–‡ä»¶ï¼"
                  
                  # è·å–æäº¤URLï¼ˆå¦‚æœæœ‰ï¼‰
                  local commit_url=$(echo "$response_body" | grep -o '"html_url":"[^"]*"' | cut -d':' -f2- | tr -d '"')
                  if [ -n "$commit_url" ]; then
                    echo "ğŸ”— æäº¤URL: $commit_url"
                  fi
                  
                  return 0
                else
                  echo "âš ï¸  å“åº”ä¸­æœªæ‰¾åˆ°é¢„æœŸå­—æ®µï¼Œä½†HTTPçŠ¶æ€ç ä¸ºæˆåŠŸ"
                  echo "å“åº”é¢„è§ˆ: $(echo "$response_body" | head -n 3)"
                  return 0  # çŠ¶æ€ç æˆåŠŸæ—¶è®¤ä¸ºä¸Šä¼ æˆåŠŸ
                fi
              fi
              
              # è¯¦ç»†é”™è¯¯åˆ†æ
              local error_message=$(echo "$response_body" | grep -o '"message":"[^"]*"' | cut -d':' -f2 | tr -d '"' || echo "æœªçŸ¥é”™è¯¯")
              echo "âŒ ä¸Šä¼ å¤±è´¥ï¼Œé”™è¯¯ä¿¡æ¯: $error_message"
              
              # å¤„ç†ç‰¹å®šé”™è¯¯ç±»å‹
              if [ "$http_code" -eq 409 ] || echo "$error_message" | grep -q -E 'sha|conflict'; then
                echo "ğŸ”„ æ£€æµ‹åˆ°ç‰ˆæœ¬å†²çªæˆ–SHAæ— æ•ˆï¼Œå°†é‡æ–°è·å–æœ€æ–°SHA..."
                current_sha=""  # å¼ºåˆ¶ä¸‹æ¬¡è·å–æ–°SHA
                continue  # ç«‹å³é‡è¯•ï¼Œä¸ç­‰å¾…
              elif [ "$http_code" -eq 401 ]; then
                echo "âŒ æˆæƒå¤±è´¥ï¼Œä»¤ç‰Œå¯èƒ½æ— æ•ˆæˆ–æƒé™ä¸è¶³"
                echo "å“åº”é¢„è§ˆ: $(echo "$response_body" | head -n 3)"
                return 1  # ä¸å†é‡è¯•æˆæƒé”™è¯¯
              elif [ "$http_code" -eq 403 ]; then
                echo "âš ï¸  APIé€Ÿç‡é™åˆ¶æˆ–æƒé™ä¸è¶³ï¼ˆ403ï¼‰"
                local reset_time=$(echo "$response_body" | grep -o '"reset":"[^"]*"' | cut -d':' -f2- | tr -d '"')
                if [ -n "$reset_time" ]; then
                  echo "ğŸ“… é€Ÿç‡é™åˆ¶é‡ç½®æ—¶é—´: $reset_time"
                fi
                # å¢åŠ ç­‰å¾…æ—¶é—´
              elif [ "$http_code" -ge 500 ] && [ "$http_code" -lt 600 ]; then
                echo "âš ï¸  GitHubæœåŠ¡å™¨é”™è¯¯ ($http_code)ï¼Œå°†é‡è¯•..."
                # æœåŠ¡å™¨é”™è¯¯éœ€è¦æ›´æ¿€è¿›çš„é‡è¯•
              elif [ "$http_code" -eq 404 ]; then
                echo "âš ï¸  èµ„æºä¸å­˜åœ¨ï¼ˆ404ï¼‰ï¼Œå°†å°è¯•ä½œä¸ºæ–°æ–‡ä»¶åˆ›å»º"
                current_sha=""  # å¼ºåˆ¶åˆ›å»ºæ–°æ–‡ä»¶
                continue  # ç«‹å³é‡è¯•
              else
                echo "âŒ æœªçŸ¥é”™è¯¯ï¼ŒHTTPçŠ¶æ€ç : $http_code"
              fi
              
              # æŒ‡æ•°é€€é¿ç­–ç•¥
              if [ $retry_count -lt $max_retries ]; then
                local delay=$((base_delay * (2 ** (retry_count - 1))))
                # å¢åŠ éšæœºæŠ–åŠ¨ï¼ˆÂ±20%ï¼‰ä»¥é¿å…é‡è¯•é£æš´
                local jitter=$((RANDOM % (delay / 5) + 1))
                if [ $((RANDOM % 2)) -eq 0 ]; then
                  delay=$((delay + jitter))
                else
                  delay=$((delay - jitter))
                fi
                
                # ç¡®ä¿å»¶è¿Ÿè‡³å°‘ä¸º1ç§’
                if [ $delay -lt 1 ]; then delay=1; fi
                
                echo "â±ï¸  $delayç§’åé‡è¯•..."
                sleep $delay
              fi
            done
            
            echo "âŒ æ‰€æœ‰ä¸Šä¼ å°è¯•å‡å¤±è´¥"
            echo "ğŸ“‹ æœ€åå“åº”é¢„è§ˆ: $(echo "$response_body" | head -n 5)"
            return 1
          }
          
          # åˆå§‹åŒ–ç½‘ç»œé”™è¯¯è®¡æ•°å™¨
          network_error_count=0
          
          # ç³»ç»Ÿå¥åº·æ£€æŸ¥
          echo "ğŸ¥ ç³»ç»Ÿå¥åº·æ£€æŸ¥..."
          echo "ğŸ“Š å½“å‰æ—¶é—´: $(date)"
          echo "ğŸ“¡ ç½‘ç»œè¿æ¥æµ‹è¯•..."
          ping -c 2 api.github.com >/dev/null 2>&1 && echo "âœ… ç½‘ç»œè¿æ¥æ­£å¸¸" || echo "âš ï¸  ç½‘ç»œè¿æ¥æµ‹è¯•å¤±è´¥ï¼Œä½†å°†ç»§ç»­å°è¯•"
          
          # ç¡®ä¿ç¯å¢ƒå˜é‡é…ç½®æ­£ç¡®
          echo "ğŸ” ğŸ›¡ï¸  éªŒè¯GitHub APIç¯å¢ƒ..."
          echo "  - ä»“åº“æ‰€æœ‰è€…: ${REPO_OWNER:-'æœªè®¾ç½®'}"
          echo "  - ä»“åº“åç§°: ${REPO_NAME:-'æœªè®¾ç½®'}"
          echo "  - åˆ†æ”¯: ${BRANCH:-'æœªè®¾ç½®'}"
          echo "  - APIç‰ˆæœ¬: ${GITHUB_API_VERSION:-'æœªè®¾ç½®'}"
          echo "  - ç”¨æˆ·ä»£ç†: ${USER_AGENT:-'æœªè®¾ç½®'}"
          
          # ç¯å¢ƒå˜é‡å®Œæ•´æ€§æ£€æŸ¥
          if [ -z "$REPO_OWNER" ] || [ -z "$REPO_NAME" ] || [ -z "$BRANCH" ]; then
            echo "âš ï¸  ğŸš¨ è­¦å‘Š: å…³é”®ç¯å¢ƒå˜é‡æœªå®Œå…¨è®¾ç½®ï¼Œå°†å°è¯•ä½¿ç”¨é»˜è®¤å€¼"
            [ -z "$BRANCH" ] && BRANCH="main" && echo "  - å·²è®¾ç½®é»˜è®¤åˆ†æ”¯: $BRANCH"
          fi
          
          # å·¥ä½œç›®å½•çŠ¶æ€æ£€æŸ¥
          echo "ğŸ“ ğŸ§¹ å·¥ä½œç›®å½•æ£€æŸ¥..."
          ls -la
          
          # ä½¿ç”¨APIæ›´æ–°ä¸»æ–‡ä»¶ï¼ˆåŸå­æ“ä½œï¼‰
          echo "ğŸš€ ğŸ¯ å¼€å§‹ä½¿ç”¨GitHub APIåŸå­æ›´æ–°ä¸»æ–‡ä»¶..."
          echo "ğŸ“‹ æ“ä½œè¯¦æƒ…:"
          echo "  - ç›®æ ‡æ–‡ä»¶: tzydauto.txt"
          echo "  - æ›´æ–°æ¨¡å¼: åŸºäºSHAçš„åŸå­æ“ä½œ"
          echo "  - é‡è¯•ç­–ç•¥: æ™ºèƒ½æŒ‡æ•°é€€é¿"
          
          # ä¸Šä¼ ä¸»æ–‡ä»¶
          upload_with_retry "tzydauto.txt"
          main_update_status=$?
          
          # ä¸Šä¼ è¾…åŠ©æ—¥å¿—æ–‡ä»¶
          debug_logs_status=0
          if [ -f "debug_output.txt" ]; then
            echo "ğŸ“‹ å°è¯•ä¸Šä¼ è°ƒè¯•æ—¥å¿—..."
            upload_with_retry "debug_output.txt"
            debug_logs_status=$?
          fi
          
          if [ -f "tvzy.log" ]; then
            echo "ğŸ“Š å°è¯•ä¸Šä¼ è„šæœ¬æ—¥å¿—..."
            upload_with_retry "tvzy.log"
            # æ—¥å¿—æ–‡ä»¶çš„çŠ¶æ€ä¸å½±å“ä¸»æµç¨‹
          fi
          
          # åˆ›å»ºä¸€ä¸ªç®€å•çš„æˆåŠŸæ ‡è®°æ–‡ä»¶
          echo "ğŸ”– åˆ›å»ºæ›´æ–°çŠ¶æ€æ ‡è®°æ–‡ä»¶..."
          echo "Last successful update: $(date)" > update_status.txt
          upload_with_retry "update_status.txt"
          
          # ç¡®å®šæœ€ç»ˆçŠ¶æ€ï¼ˆä¸»æ–‡ä»¶æˆåŠŸæ‰è§†ä¸ºæ•´ä½“æˆåŠŸï¼‰
          echo "ğŸ“Š ğŸ“‹ æ“ä½œç»“æœæ±‡æ€»..."
          
          if [ $main_update_status -eq 0 ]; then
            echo "ğŸ‰ ğŸ‰ ğŸ‰ ğŸ‰ ä¸»æ–‡ä»¶æ›´æ–°æˆåŠŸï¼å·¥ä½œæµæ‰§è¡Œå®Œæˆï¼"
            
            # ç”Ÿæˆè¯¦ç»†æ‰§è¡ŒæŠ¥å‘Š
            echo "ğŸ“‹ ğŸ“Š APIæ›´æ–°æ“ä½œå®Œæ•´æŠ¥å‘Š:"
            echo "âœ… ğŸ¯ ä¸»æ–‡ä»¶: tzydauto.txt (æˆåŠŸ)"
            
            # æ—¥å¿—æ–‡ä»¶çŠ¶æ€è¯¦ç»†æŠ¥å‘Š
            if [ -f "debug_output.txt" ]; then 
              if [ $debug_logs_status -eq 0 ]; then
                echo "âœ… ğŸ“ æ—¥å¿—æ–‡ä»¶: debug_output.txt (æˆåŠŸ)"
              elif [ $debug_logs_status -eq 1 ]; then
                echo "âš ï¸ ğŸ“ æ—¥å¿—æ–‡ä»¶: debug_output.txt (å·²å°è¯•ä½†å¤±è´¥)"
              elif [ $debug_logs_status -eq 2 ]; then
                echo "âŒ ğŸ“ æ—¥å¿—æ–‡ä»¶: debug_output.txt (è‡´å‘½é”™è¯¯)"
              else
                echo "â„¹ï¸ ğŸ“ æ—¥å¿—æ–‡ä»¶: debug_output.txt (çŠ¶æ€æœªçŸ¥)"
              fi
            else
              echo "â„¹ï¸ ğŸ“ æ—¥å¿—æ–‡ä»¶: debug_output.txt (ä¸å­˜åœ¨)"
            fi
            
            if [ -f "tvzy.log" ]; then 
              echo "â„¹ï¸ ğŸ“Š æ—¥å¿—æ–‡ä»¶: tvzy.log (å·²å°è¯•ä¸Šä¼ )"
            else
              echo "â„¹ï¸ ğŸ“Š æ—¥å¿—æ–‡ä»¶: tvzy.log (ä¸å­˜åœ¨)"
            fi
            
            echo "ğŸ”– â° çŠ¶æ€æ–‡ä»¶: update_status.txt (å·²åˆ›å»º)"
            echo "â° ğŸ“… å®Œæˆæ—¶é—´: $(date +'%Y-%m-%d %H:%M:%S')"
            echo "ğŸ† âœ… åŸºäºGitHub APIçš„åŸå­æ›´æ–°æ–¹æ¡ˆæ‰§è¡ŒæˆåŠŸï¼"
            echo "ğŸ¯ ä¼˜åŠ¿: å®Œå…¨é¿å…Git Pushå†²çªï¼ŒåŸºäºSHAçš„ä¹è§‚å¹¶å‘æ§åˆ¶ç¡®ä¿æ•°æ®ä¸€è‡´æ€§"
            echo "âœ… å·¥ä½œæµæ‰§è¡ŒæˆåŠŸï¼"
            exit 0
          else
            echo "âŒ âŒ âŒ âŒ é”™è¯¯: ä¸»æ–‡ä»¶æ›´æ–°å¤±è´¥"
            echo "ğŸ“‹ ğŸ› ï¸  è¯¦ç»†é”™è¯¯è¯Šæ–­:"
            
            # æ ¹æ®é”™è¯¯ç æä¾›æ›´ç²¾ç¡®çš„è¯Šæ–­
            case "$main_update_status" in
              1)
                echo "âš ï¸  å¸¸è§„å¤±è´¥: å¯èƒ½æ˜¯ç½‘ç»œé—®é¢˜æˆ–APIé™åˆ¶"
                ;;
              2)
                echo "ğŸš¨ è‡´å‘½é”™è¯¯: æ–‡ä»¶é¢„å¤„ç†å¤±è´¥ï¼Œæ£€æŸ¥æ–‡ä»¶æ ¼å¼å’Œæƒé™"
                ;;
              *)
                echo "â“ æœªçŸ¥é”™è¯¯: çŠ¶æ€ç  $main_update_status"
                ;;
            esac
            
            echo "ğŸ” æ•…éšœæ’é™¤æ­¥éª¤:"
            echo "1. ğŸ” æ£€æŸ¥GitHub Tokenæƒé™å’Œæœ‰æ•ˆæ€§"
            echo "2. ğŸ“ éªŒè¯tzydauto.txtæ–‡ä»¶æ˜¯å¦å­˜åœ¨ã€å¯è¯»ä¸”æ ¼å¼æ­£ç¡®"
            echo "3. ğŸ“ ç¡®è®¤æ–‡ä»¶å¤§å°ä¸è¶…è¿‡GitHub 100MBé™åˆ¶"
            echo "4. ğŸŒ æ£€æŸ¥GitHub APIæœåŠ¡çŠ¶æ€æ˜¯å¦æ­£å¸¸"
            echo "5. ğŸš« éªŒè¯ä»“åº“åˆ†æ”¯ä¿æŠ¤è§„åˆ™é…ç½®"
            echo "6. â±ï¸  è€ƒè™‘APIè¯·æ±‚é¢‘ç‡é™åˆ¶é—®é¢˜"
            echo "7. ğŸ“Š æŸ¥çœ‹å®Œæ•´å·¥ä½œæµæ—¥å¿—è·å–è¯¦ç»†é”™è¯¯ä¿¡æ¯"
            
            exit 1
          fi
      
      - name: å‘é€æˆåŠŸé€šçŸ¥
        if: success()
        run: |
          echo "ğŸ‰ ğŸ‰ ğŸ‰ ç”µè§†ç›´æ’­çº¿è·¯è‡ªåŠ¨æ›´æ–°æˆåŠŸï¼"
          echo "ğŸ“ å·²æ›´æ–°æ–‡ä»¶: tzydauto.txt"
          echo "ğŸ”„ ä½¿ç”¨GitHub APIåŸå­æ›´æ–°æ–¹æ¡ˆï¼Œå®Œå…¨é¿å…Git Pushå†²çª"
          echo "âœ… åŸºäºSHAçš„ä¹è§‚å¹¶å‘æ§åˆ¶ç¡®ä¿æ•°æ®ä¸€è‡´æ€§"
          echo "ğŸ“Š è¿è¡Œæ—¶é—´: $(date)"
          echo "ğŸ† å·¥ä½œæµæ‰§è¡ŒæˆåŠŸå®Œæˆï¼"
      
      - name: å‘é€å¤±è´¥é€šçŸ¥
        if: failure()
        run: |
          echo "âŒ âŒ âŒ ç”µè§†ç›´æ’­çº¿è·¯è‡ªåŠ¨æ›´æ–°å¤±è´¥ï¼"
          echo "ğŸ“‹ é”™è¯¯è¯Šæ–­ä¿¡æ¯:"
          echo "- æ£€æŸ¥GitHub APIæƒé™è®¾ç½®"
          echo "- éªŒè¯æ–‡ä»¶æ ¼å¼å’Œå¤§å°"
          echo "- æŸ¥çœ‹è¯¦ç»†å·¥ä½œæµæ—¥å¿—è·å–å®Œæ•´é”™è¯¯ä¿¡æ¯"
          echo "- è€ƒè™‘æ£€æŸ¥ä»“åº“åˆ†æ”¯ä¿æŠ¤è§„åˆ™"
          exit 1
