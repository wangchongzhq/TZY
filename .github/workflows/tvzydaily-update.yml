name: TVZY Daily Update

on:
  # æ¯å¤©å®šæ—¶è¿è¡Œ
  schedule:
    - cron: '0 0 * * *'  # æ¯å¤©UTC 0ç‚¹è¿è¡Œ
  # å…è®¸æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      logLevel:
        description: 'Log level'
        required: true
        default: 'info'

jobs:
  update-tv-channels:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # ç¡®ä¿æœ‰å†™æƒé™
    steps:
      # ç¬¬ä¸€æ­¥ï¼šæ£€å‡ºä»£ç ï¼ˆè·å–å®Œæ•´å†å²ä»¥é¿å…å†²çªï¼‰
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          ref: main
          fetch-depth: 0  # è·å–å®Œæ•´å†å²
          persist-credentials: true  # å¯ç”¨gitå‡­æ®
      
      # ç¬¬äºŒæ­¥ï¼šè®¾ç½®gitç”¨æˆ·ä¿¡æ¯
      - name: Setup git configuration
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          # ç¡®ä¿å·¥ä½œç›®å½•å¹²å‡€
          git reset --hard
          git clean -fdx
      
      # ç¬¬ä¸‰æ­¥ï¼šè®¾ç½®Pythonç¯å¢ƒ
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
      
      # ç¬¬å››æ­¥ï¼šå®‰è£…ä¾èµ–
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests schedule
      
      # ç¬¬äº”æ­¥ï¼šç”Ÿæˆæ–‡ä»¶å¹¶ä½¿ç”¨GitHub APIä¸Šä¼ ï¼ˆå®Œå…¨æ— git pushç‰ˆæœ¬ï¼‰
      - name: Generate and upload file using GitHub API (push-free version)
        run: |
          set -e  # é‡åˆ°é”™è¯¯ç«‹å³é€€å‡º
          
          echo "ğŸ”„ å¼€å§‹ç”Ÿæˆç›´æ’­æºæ–‡ä»¶..."
          
          # è¿è¡Œè„šæœ¬ç”Ÿæˆæ–‡ä»¶
          python tvzydaily.py || {
            echo "âŒ è„šæœ¬æ‰§è¡Œå¤±è´¥ï¼Œå°è¯•ä½¿ç”¨å¤‡ç”¨è„šæœ¬..."
            if [ -f "simple_create_tzydauto.py" ]; then
              python simple_create_tzydauto.py
            else
              echo "âŒ å¤‡ç”¨è„šæœ¬ä¸å­˜åœ¨ï¼Œä»»åŠ¡å¤±è´¥"
              exit 1
            fi
          }
          
          # éªŒè¯æ–‡ä»¶ç”Ÿæˆ
          if [ ! -f "tzydauto.txt" ]; then
            echo "âŒ é”™è¯¯: tzydauto.txt æ–‡ä»¶æœªç”Ÿæˆ"
            exit 1
          fi
          
          echo "âœ… æ–‡ä»¶ç”ŸæˆæˆåŠŸï¼Œå†…å®¹ç»Ÿè®¡ï¼š"
          wc -l tzydauto.txt
          head -n 5 tzydauto.txt
          
          echo "ğŸ”„ ä½¿ç”¨GitHub APIç›´æ¥ä¸Šä¼ æ–‡ä»¶ï¼ˆå®Œå…¨æ— git pushï¼‰..."
          
          # å‡½æ•°ï¼šè·å–æ–‡ä»¶å½“å‰SHAä»¥å¤„ç†å¹¶å‘æ›´æ–°
          get_current_sha() {
            echo "ğŸ” è·å–å½“å‰æ–‡ä»¶SHAä»¥æ”¯æŒå¹¶å‘æ›´æ–°..."
            local response=$(curl -s \
                -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
                -H "Accept: application/vnd.github+json" \
                "https://api.github.com/repos/wangchongzhq/zhby/contents/tzydauto.txt")
            
            # æ£€æŸ¥å“åº”æ˜¯å¦æœ‰æ•ˆ
            if echo "$response" | grep -q '"sha":"'; then
              local sha=$(echo "$response" | grep -o '"sha":"[^"]*"' | cut -d'"' -f4)
              echo "âœ… è·å–åˆ°å½“å‰SHA: $sha"
              echo "$sha"
              return 0
            else
              echo "âš ï¸  æœªæ‰¾åˆ°ç°æœ‰æ–‡ä»¶æˆ–æ— æ³•è·å–SHAï¼Œå°†åˆ›å»ºæ–°æ–‡ä»¶"
              echo ""
              return 0
            fi
          }
          
          # é‡è¯•æœºåˆ¶å‡½æ•°
          upload_with_retry() {
            local retry_count=0
            local max_retries=3
            local success=false
            
            while [ $retry_count -lt $max_retries ] && [ "$success" = false ]; do
              ((retry_count++))
              echo "â±ï¸  ä¸Šä¼ å°è¯• $retry_count/$max_retries..."
              
              # æ¯æ¬¡å°è¯•éƒ½è·å–æœ€æ–°çš„SHAï¼Œä»¥å¤„ç†å¯èƒ½çš„å¹¶å‘æ›´æ–°
              local current_sha=$(get_current_sha)
              
              # è·å–æ–‡ä»¶å†…å®¹å¹¶ç¼–ç ä¸ºbase64
              CONTENT=$(base64 -w 0 tzydauto.txt)
              
              # åˆ›å»ºæ—¥æœŸæ—¶é—´æˆ³
              TIMESTAMP=$(date +'%Y-%m-%d %H:%M:%S')
              
              # æ„å»ºJSONæ•°æ®
              if [ -n "$current_sha" ]; then
                echo "ğŸ“ æ›´æ–°ç°æœ‰æ–‡ä»¶ï¼Œä½¿ç”¨SHA: $current_sha"
                JSON_DATA=$(printf '{"message":"Auto-update IPTV files - %s","content":"%s","sha":"%s","branch":"main"}' "$TIMESTAMP" "$CONTENT" "$current_sha")
              else
                echo "ğŸ“ åˆ›å»ºæ–°æ–‡ä»¶"
                JSON_DATA=$(printf '{"message":"Auto-update IPTV files - %s","content":"%s","branch":"main"}' "$TIMESTAMP" "$CONTENT")
              fi
              
              # ä½¿ç”¨curlè°ƒç”¨GitHub APIï¼Œæ·»åŠ è¶…æ—¶å’Œé‡è¯•å‚æ•°
              RESPONSE=$(curl -s -X PUT \
                  --max-time 45 \
                  --retry 2 \
                  --retry-delay 8 \
                  -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
                  -H "Accept: application/vnd.github+json" \
                  -H "Content-Type: application/json" \
                  "https://api.github.com/repos/wangchongzhq/zhby/contents/tzydauto.txt" \
                  --data "$JSON_DATA")
              
              # è¯¦ç»†è®°å½•å“åº”
              echo "ğŸ“Š APIå“åº”çŠ¶æ€æ£€æŸ¥..."
              
              # æ›´å¥å£®çš„å“åº”æ£€æŸ¥
              if echo "$RESPONSE" | grep -q -E '"content":|"sha":"'; then
                echo "âœ… âœ… âœ… æˆåŠŸä½¿ç”¨GitHub APIæ›´æ–°æ–‡ä»¶ï¼"
                success=true
                return 0
              else
                echo "âŒ ä¸Šä¼ å¤±è´¥ï¼Œå°è¯• $retry_count/$max_retries"
                echo "é”™è¯¯è¯¦æƒ…: $(echo "$RESPONSE" | grep -E '"message":|"documentation_url":|"errors":')"
                if [ $retry_count -lt $max_retries ]; then
                  echo "â±ï¸  $((retry_count * 10))ç§’åé‡è¯•..."
                  sleep $((retry_count * 10))
                fi
              fi
            done
            
            echo "âŒ æ‰€æœ‰ä¸Šä¼ å°è¯•å‡å¤±è´¥"
            echo "è¯¦ç»†é”™è¯¯å“åº”: $RESPONSE"
            return 1
          }
          
          # æ‰§è¡Œä¸Šä¼ æ“ä½œ
          if upload_with_retry; then
            echo "ğŸ‰ æ–‡ä»¶ä¸Šä¼ æˆåŠŸå®Œæˆï¼"
            
            # éªŒè¯ä¸Šä¼ ç»“æœ
            echo "ğŸ” éªŒè¯ä¸Šä¼ ç»“æœ..."
            VERIFY_RESPONSE=$(curl -s \
                -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
                -H "Accept: application/vnd.github+json" \
                "https://api.github.com/repos/wangchongzhq/zhby/contents/tzydauto.txt")
            
            if echo "$VERIFY_RESPONSE" | grep -q -E '"name":"tzydauto.txt"'; then
              echo "âœ… æ–‡ä»¶å­˜åœ¨äºä»“åº“ä¸­ï¼Œä¸Šä¼ éªŒè¯æˆåŠŸï¼"
            else
              echo "âš ï¸  ä¸Šä¼ éªŒè¯å¤±è´¥ï¼Œä½†ä¸»è¦ä¸Šä¼ æ­¥éª¤å·²å®Œæˆ"
            fi
          else
            echo "âŒ ä¸Šä¼ ä»»åŠ¡æœ€ç»ˆå¤±è´¥"
            exit 1
          fi
