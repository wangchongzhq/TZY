name: æ’­æ”¾æºè‡ªåŠ¨æ›´æ–°

on:
  workflow_dispatch:
    inputs:
      update_reason:
        description: 'æ›´æ–°åŸå› ï¼ˆå¯é€‰ï¼‰'
        required: false
        default: 'æ‰‹åŠ¨è§¦å‘æ’­æ”¾æºæ›´æ–°'

jobs:
  update-sources:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: æ£€å‡ºä»£ç ä»“åº“
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: true
      
      - name: è®¾ç½®Pythonç¯å¢ƒ
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'
          cache: 'pip'
      
      - name: å®‰è£…ä¾èµ–
        run: |
          python -m pip install --upgrade pip
      
      - name: è¿è¡Œæ’­æ”¾æºæ›´æ–°è„šæœ¬
        run: |
          chmod +x ./update_sources.py
          python ./update_sources.py
      
      - name: æ£€æŸ¥æ˜¯å¦æœ‰æ›´æ”¹
        id: check_changes
        run: |
          # æ£€æŸ¥æ˜¯å¦æœ‰æ–‡ä»¶è¢«ä¿®æ”¹
          if git diff --quiet; then
            echo "changes=false" >> $GITHUB_OUTPUT
          else
            echo "changes=true" >> $GITHUB_OUTPUT
          fi
      
      - name: æäº¤å’Œæ¨é€æ›´æ–°
        if: steps.check_changes.outputs.changes == 'true'
        run: |
          # é…ç½®gitèº«ä»½å’Œè¡Œä¸º
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "GitHub Actions Bot"
          git config --global pull.rebase false  # ä½¿ç”¨mergeè€Œä¸æ˜¯rebase
          git config --global core.autocrlf false  # é˜²æ­¢è¡Œå°¾å­—ç¬¦è½¬æ¢é—®é¢˜
          
          echo "=== å¼€å§‹Gitæ“ä½œ ==="
          echo "å½“å‰åˆ†æ”¯: $(git branch --show-current)"
          
          # ç›´æ¥ä½¿ç”¨originè¿œç¨‹ä»“åº“
          echo "åŒæ­¥æœ¬åœ°ä¸è¿œç¨‹ä»“åº“..."
          git remote -v
          git fetch origin ${{ github.ref_name }}
          git checkout ${{ github.ref_name }} || git checkout -b ${{ github.ref_name }}
          git reset --hard origin/${{ github.ref_name }}
          
          echo "æœ¬åœ°ä»“åº“å·²é‡ç½®ä¸ºè¿œç¨‹æœ€æ–°çŠ¶æ€"
          
          # é‡æ–°æ‰§è¡Œæ›´æ–°è„šæœ¬ç¡®ä¿ç”Ÿæˆæœ€æ–°æ–‡ä»¶
          echo "é‡æ–°æ‰§è¡Œæ›´æ–°è„šæœ¬ç”Ÿæˆæœ€æ–°æ–‡ä»¶..."
          python ./update_sources.py
          
          # æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨
          if [ ! -f "./unified_sources.py" ]; then
            echo "::error::é”™è¯¯ï¼šunified_sources.pyæ–‡ä»¶æœªç”Ÿæˆ"
            exit 1
          fi
          
          # æ·»åŠ æ‰€æœ‰æ›´æ”¹çš„æ–‡ä»¶
          echo "æ·»åŠ æ›´æ”¹çš„æ–‡ä»¶..."
          git add ./unified_sources.py
          git add ./*.py  # æ·»åŠ æ‰€æœ‰Pythonè„šæœ¬æ–‡ä»¶
          git add jieguo.txt || true  # åªæ·»åŠ å®é™…ç”Ÿæˆçš„TXTæ–‡ä»¶
          
          # æ£€æŸ¥æ˜¯å¦æœ‰æ›´æ”¹
          if git diff --staged --quiet; then
            echo "æ²¡æœ‰æ£€æµ‹åˆ°æ›´æ”¹ï¼Œè·³è¿‡æäº¤"
            exit 0
          fi
          
          # è·å–å½“å‰æ—¥æœŸï¼ˆåŒ—äº¬æ—¶é—´ï¼‰
          TODAY=$(TZ='Asia/Shanghai' date +'%Y-%m-%d %H:%M:%S')
          # ä½¿ç”¨æ‰‹åŠ¨è§¦å‘çš„åŸå› æˆ–é»˜è®¤æ¶ˆæ¯
          if [ -n "${{ github.event.inputs.update_reason }}" ]; then
            REASON="${{ github.event.inputs.update_reason }}"
          else
            REASON="è‡ªåŠ¨æ›´æ–°æ’­æ”¾æº $TODAY"
          fi
          
          # æäº¤æ›´æ”¹
          echo "æäº¤æ›´æ”¹..."
          git commit -m "${REASON}"
          
          # æ¨é€æ›´æ”¹
          echo "å°è¯•æ¨é€æ›´æ”¹åˆ°è¿œç¨‹ä»“åº“..."
          # ç›´æ¥æ¨é€åˆ°origin
          git push origin ${{ github.ref_name }} || {
            echo "æ¨é€å¤±è´¥ï¼Œå°è¯•ä½¿ç”¨--force-with-leaseæ¨é€..."
            git push --force-with-lease origin ${{ github.ref_name }} || {
              echo "--force-with-leaseæ¨é€å¤±è´¥ï¼Œæœ€åå°è¯•ä½¿ç”¨--forceæ¨é€..."
              git push --force origin ${{ github.ref_name }} || {
                echo "::error::æ‰€æœ‰æ¨é€æ–¹å¼å‡å¤±è´¥ï¼Œè¯·æ£€æŸ¥GitHubæƒé™é…ç½®"
                exit 1
              }
            }
          }
          
          echo "æ›´æ–°å·²æäº¤å¹¶æ¨é€"
      
      - name: è¾“å‡ºæˆåŠŸæ¶ˆæ¯
        if: steps.check_changes.outputs.changes == 'true'
        run: |
          echo "ğŸ‰ æ’­æ”¾æºæ›´æ–°å®Œæˆï¼"
          echo "ğŸ“ æ›´æ–°çš„æ–‡ä»¶: unified_sources.py åŠç›¸å…³è„šæœ¬"
      
      - name: è¾“å‡ºæ— æ›´æ”¹æ¶ˆæ¯
        if: steps.check_changes.outputs.changes == 'false'
        run: |
          echo "â„¹ï¸  æœªæ£€æµ‹åˆ°éœ€è¦æ›´æ–°çš„å†…å®¹"
