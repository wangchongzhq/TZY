name: Generate IPZY M3U

on:
  push:
    branches: [ main ]
  schedule:
    - cron: '0 22 * * *'# 每天UTC时间22点自动运行，相当于北京时间第二天早晨6点
  workflow_dispatch: # 手动触发选项

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # 添加写入权限

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        repository: wangchongzhq/TZY
        persist-credentials: true  # 保持凭据以便推送

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install requests

    - name: Run script to generate m3u
      run: echo "ipzyauto.py已被删除，跳过此步骤"

    - name: Debug - List generated files
      run: ls -la

    - name: Commit and push if changes
      run: |
        # 配置git身份和行为
        git config --local user.email "github-actions[bot]@users.noreply.github.com"
        git config --local user.name "GitHub Actions Bot"
        git config --global pull.rebase false  # 使用merge而不是rebase
        git config --global core.autocrlf false  # 防止行尾字符转换问题
        
        echo "=== 开始Git操作 ==="
        echo "当前分支: $(git branch --show-current)"
        
        # 直接使用origin远程仓库
        echo "同步本地与远程仓库..."
        git remote -v
        git fetch origin ${{ github.ref_name }}
        git checkout ${{ github.ref_name }} || git checkout -b ${{ github.ref_name }}
        git reset --hard origin/${{ github.ref_name }}
        
        echo "本地仓库已重置为远程最新状态"
        
        # 重新执行脚本确保生成最新文件
        echo "ipzyauto.py已被删除，跳过此步骤"
        
        # 检查文件是否存在
        if [ ! -f "ipzy.m3u" ]; then
          echo "ipzy.m3u文件未生成，跳过提交"
          exit 0
        fi
        
        # 添加文件
        echo "添加更改的文件..."
        git add ipzy.m3u
        
        # 检查是否有更改
        if git diff --staged --quiet; then
          echo "没有检测到更改，跳过提交"
          exit 0
        fi
        
        # 提交更改
        echo "提交更改..."
        git commit -m "Auto-update IPTV files - $(date '+%Y-%m-%d %H:%M:%S')"
        
        # 推送到远程仓库
        echo "尝试推送更改到远程仓库..."
        # 直接推送到origin
        git push origin ${{ github.ref_name }} || {
          echo "推送失败，尝试使用--force-with-lease推送..."
          git push --force-with-lease origin ${{ github.ref_name }} || {
            echo "--force-with-lease推送失败，最后尝试使用--force推送..."
            git push --force origin ${{ github.ref_name }} || {
              echo "::error::所有推送方式均失败，请检查GitHub权限配置"
              exit 1
            }
          }
        }
