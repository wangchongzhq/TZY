name: Generate IPTV TXT Auto

on:
  schedule:
    # åŒ—äº¬æ—¶é—´æ—©æ™¨2ç‚¹è¿è¡Œ (UTCæ—¶é—´18ç‚¹ï¼Œå› ä¸ºGitHub Actionsä½¿ç”¨UTCæ—¶é—´)
    - cron: '0 18 * * *'
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘
  push:
    branches: [ main ]

jobs:
  generate-iptv:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # æˆäºˆå†™å…¥å†…å®¹çš„æƒé™
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        repository: wangchongzhq/TZY
        persist-credentials: true  # ä¿æŒå‡­æ®ä»¥ä¾¿æ¨é€
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install requests
        
    - name: Run IPTV generator
      run: |
        python ipzyauto.py
        
    - name: Display file stats
      run: |
        echo "ç”Ÿæˆçš„æ–‡ä»¶ç»Ÿè®¡:"
        if [ -f "ipzyauto.txt" ]; then
          echo "ğŸ“º é¢‘é“æ–‡ä»¶: $(wc -l < ipzyauto.txt) è¡Œ"
          echo "ğŸ“Š å®é™…é¢‘é“æ•°: $(grep -c "^[^#]" ipzyauto.txt || echo "0")"
        fi
        
    - name: Commit and push if changed
      run: |
        # é…ç½®gitèº«ä»½å’Œè¡Œä¸º
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git config --global pull.rebase false  # ä½¿ç”¨mergeè€Œä¸æ˜¯rebase
        git config --global core.autocrlf false  # é˜²æ­¢è¡Œå°¾å­—ç¬¦è½¬æ¢é—®é¢˜
        
        echo "=== å¼€å§‹Gitæ“ä½œ ==="
        echo "å½“å‰åˆ†æ”¯: $(git branch --show-current)"
        
        # é…ç½®TZYè¿œç¨‹ä»“åº“ï¼ˆä½¿ç”¨ä¸originç›¸åŒçš„URLï¼‰
        echo "é…ç½®TZYè¿œç¨‹ä»“åº“..."
        git remote -v
        git remote add TZY $(git remote get-url origin) || echo "TZYè¿œç¨‹ä»“åº“å·²å­˜åœ¨"
        git remote -v
        
        # å¼ºåˆ¶ç¡®ä¿æœ¬åœ°åˆ†æ”¯ä¸è¿œç¨‹åŒæ­¥
        echo "å¼ºåˆ¶åŒæ­¥æœ¬åœ°ä¸è¿œç¨‹ä»“åº“..."
        git fetch TZY || echo "fetch TZYå¤±è´¥ï¼Œå°è¯•ç›´æ¥ä½¿ç”¨origin"
        git checkout main || git checkout -b main
        git reset --hard TZY/main || git reset --hard origin/main
        
        echo "æœ¬åœ°ä»“åº“å·²é‡ç½®ä¸ºè¿œç¨‹æœ€æ–°çŠ¶æ€"
        
        # é‡æ–°æ‰§è¡Œè„šæœ¬ç¡®ä¿ç”Ÿæˆæœ€æ–°æ–‡ä»¶
        echo "é‡æ–°æ‰§è¡Œè„šæœ¬ç”Ÿæˆæœ€æ–°æ–‡ä»¶..."
        python ipzyauto.py
        
        # æ·»åŠ æ–‡ä»¶
        echo "æ·»åŠ æ›´æ”¹çš„æ–‡ä»¶..."
        git add ipzyauto.txt
        
        # æ£€æŸ¥æ˜¯å¦æœ‰æ›´æ”¹
        if git diff --staged --quiet; then
          echo "æ²¡æœ‰æ£€æµ‹åˆ°æ›´æ”¹ï¼Œè·³è¿‡æäº¤"
          exit 0
        fi
        
        # æäº¤æ›´æ”¹
        echo "æäº¤æ›´æ”¹..."
        git commit -m "Auto-update IPTV files - $(date +'%Y-%m-%d %H:%M:%S')"
        
        # æ¨é€åˆ°è¿œç¨‹ä»“åº“
        echo "å°è¯•æ¨é€æ›´æ”¹åˆ°è¿œç¨‹ä»“åº“..."
        # ç›´æ¥æ¨é€åˆ°originè€Œä¸æ˜¯åˆ›å»ºæ–°çš„è¿œç¨‹ä»“åº“å¼•ç”¨
        git push origin main || {
          echo "æ¨é€å¤±è´¥ï¼Œå°è¯•ä½¿ç”¨--force-with-leaseæ¨é€..."
          git push --force-with-lease origin main || {
            echo "--force-with-leaseæ¨é€å¤±è´¥ï¼Œæœ€åå°è¯•ä½¿ç”¨--forceæ¨é€..."
            git push --force origin main || {
              echo "::error::æ‰€æœ‰æ¨é€æ–¹å¼å‡å¤±è´¥ï¼Œè¯·æ£€æŸ¥GitHubæƒé™é…ç½®"
              exit 1
            }
          }
        }
