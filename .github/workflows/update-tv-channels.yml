name: 更新电视直播线路

on:
  # 手动触发
  workflow_dispatch:
  
  # 定时触发 - 每天北京时间早上3点（UTC时间前一天19点）
  schedule:
    - cron: '0 19 * * *'

jobs:
  update-channels:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      # 检出代码
      - name: 检出代码
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: true
          token: ${{ secrets.GITHUB_TOKEN }}  # 显式提供令牌
          repository: wangchongzhq/TZY
      
      # 设置Python环境
      - name: 设置Python环境
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
          cache: 'pip'
      
      # 安装依赖
      - name: 安装依赖
        run: |
          python -m pip install --upgrade pip
          pip install requests
      
      # 确保脚本可执行
      - name: 设置脚本权限
        run: chmod +x tvzy.py
      
      # 执行脚本收集电视直播线路
      - name: 收集电视直播线路
        run: python tvzy.py -o tzydayauto.txt
      
      # 检查输出文件是否存在
      - name: 检查输出文件
        id: check_file
        run: |
          if [ -f "tzydayauto.txt" ]; then
            echo "file_exists=true" >> $GITHUB_OUTPUT
            echo "文件大小: $(du -h tzydayauto.txt | cut -f1)" >> $GITHUB_STEP_SUMMARY
          else
            echo "file_exists=false" >> $GITHUB_OUTPUT
          fi
          
          # 记录直播源URL数量（假设该工作流使用tvzy.py）
          LIVE_SOURCES_COUNT=$(grep -o '"https://' tvzy.py | wc -l)
          echo "直播源URL数量: $LIVE_SOURCES_COUNT" >> $GITHUB_STEP_SUMMARY
      
      # 提交和推送更新后的文件
      - name: 提交和推送更改
        if: steps.check_file.outputs.file_exists == 'true'
        run: |
          # 配置git身份
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "GitHub Actions Bot"
          git config --global pull.rebase false  # 使用merge而不是rebase
          git config --global core.autocrlf false  # 防止行尾字符转换问题
          
          echo "=== 开始Git操作 ==="
          echo "当前分支: $(git branch --show-current)"
          
          # 配置TZY远程仓库（使用与origin相同的URL）
          echo "配置TZY远程仓库..."
          git remote -v
          git remote add TZY $(git remote get-url origin) || echo "TZY远程仓库已存在"
          git remote -v
          
          # 强制确保本地分支与远程同步
          echo "强制同步本地与远程仓库..."
          git fetch TZY ${{ github.ref_name }} || {
            echo "fetch TZY失败，尝试使用origin..."
            git fetch origin ${{ github.ref_name }}
          }
          git checkout ${{ github.ref_name }} || git checkout -b ${{ github.ref_name }}
          git reset --hard TZY/${{ github.ref_name }} || {
            echo "reset TZY失败，尝试使用origin..."
            git reset --hard origin/${{ github.ref_name }}
          }
          
          echo "本地仓库已重置为远程最新状态"
          
          # 重新执行脚本确保生成最新文件
          python tvzy.py -o tzydayauto.txt
          
          # 添加文件
          echo "添加更改的文件..."
          git add tzydayauto.txt
          
          # 检查是否有更改
          if git diff --staged --quiet; then
            echo "没有检测到更改，跳过提交"
            exit 0
          fi
          
          # 提交更改
          echo "提交更改..."
          git commit -m "自动更新电视直播线路 $(date +'%Y-%m-%d %H:%M:%S')"
          
          # 尝试多种推送方式，确保成功率
          echo "尝试推送更改到远程仓库..."
          git push TZY ${{ github.ref_name }} || {
            echo "推送TZY失败，尝试使用origin..."
            git push origin ${{ github.ref_name }} || {
              echo "推送origin失败，尝试使用--force-with-lease推送..."
              git push --force-with-lease TZY ${{ github.ref_name }} || {
                echo "--force-with-lease TZY推送失败，尝试使用--force-with-lease origin..."
                git push --force-with-lease origin ${{ github.ref_name }} || {
                  echo "--force-with-lease origin推送失败，最后尝试使用--force TZY推送..."
                  git push --force TZY ${{ github.ref_name }} || {
                    echo "--force TZY推送失败，最后尝试使用--force origin推送..."
                    git push --force origin ${{ github.ref_name }} || {
                      echo "::error::所有推送方式均失败，请检查GitHub权限配置"
                      exit 1
                    }
                  }
                }
              }
            }
          }
      
      # 保存输出文件作为构建产物
      - name: 保存输出文件
        if: steps.check_file.outputs.file_exists == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: tv-channels-list
          path: tzydayauto.txt
          retention-days: 7
      
      # 生成构建摘要
      - name: 生成构建摘要
        if: steps.check_file.outputs.file_exists == 'true'
        run: |
          echo "## 电视直播线路更新摘要" >> $GITHUB_STEP_SUMMARY
          echo "- 执行时间: $(date '+%Y-%m-%d %H:%M:%S')" >> $GITHUB_STEP_SUMMARY
          echo "- 输出文件: tzydayauto.txt" >> $GITHUB_STEP_SUMMARY
          echo "- 文件大小: $(du -h tzydayauto.txt | cut -f1)" >> $GITHUB_STEP_SUMMARY
          echo "- 频道数量: $(grep -v '^#' tzydayauto.txt | wc -l)" >> $GITHUB_STEP_SUMMARY
