name: 4Kè¶…é«˜æ¸…ç›´æ’­æºè‡ªåŠ¨åˆå¹¶è½¬æ¢

on:
  # å®šæ—¶è¿è¡Œï¼šæ¯å¤©å‡Œæ™¨2ç‚¹
  schedule:
    - cron: '0 18 * * *'  # UTCæ—¶é—´ï¼Œå¯¹åº”åŒ—äº¬æ—¶é—´å‡Œæ™¨2ç‚¹
  
  # æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      logLevel:
        description: 'æ—¥å¿—çº§åˆ«'
        required: true
        default: 'info'
        type: choice
        options:
          - info
          - debug
        
      forceUpdate:
        description: 'å¼ºåˆ¶æ›´æ–°æ‰€æœ‰æº'
        required: false
        default: true
        type: boolean

# æƒé™è®¾ç½®
permissions:
  contents: write  # å…è®¸å†™å…¥æ–‡ä»¶
  pull-requests: write  # å…è®¸åˆ›å»ºPR

jobs:
  merge-and-convert:
    runs-on: windows-latest
    
    steps:
      # 1. æ£€å‡ºä»£ç åº“
      - name: æ£€å‡ºä»£ç åº“
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
      
      # 2. è®¾ç½®Pythonç¯å¢ƒ
      - name: è®¾ç½®Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
          cache: 'pip'
      
      # 3. å®‰è£…ä¾èµ–
      - name: å®‰è£…ä¾èµ–
        run: |
          python -m pip install --upgrade pip
          pip install requests
      
      # 4. æ˜¾ç¤ºå½“å‰ç›®å½•ç»“æ„
      - name: æ£€æŸ¥é¡¹ç›®ç»“æ„
        run: |
          echo "ğŸ“ å½“å‰ç›®å½•ç»“æ„ï¼š"
          dir /b /s
          
          echo "ğŸ“„ æ£€æŸ¥4K_uhd_channels.txtï¼š"
          if exist 4K_uhd_channels.txt (
            echo "âœ… æ–‡ä»¶å­˜åœ¨"
            findstr /C:".m3u" 4K_uhd_channels.txt | head -10
            echo "..."
          ) else (
            echo "âŒ æ–‡ä»¶ä¸å­˜åœ¨"
          )
      
      # 5. è¿è¡Œåˆå¹¶è½¬æ¢è„šæœ¬
      - name: è¿è¡Œåˆå¹¶è½¬æ¢è„šæœ¬
        run: |
          echo "ğŸ¬ å¼€å§‹è¿è¡Œ4K_uhd_merger.py..."
          python 4K_uhd_merger.py
        env:
          # è®¾ç½®ç¯å¢ƒå˜é‡
          PYTHONIOENCODING: utf-8
      
      # 6. éªŒè¯è¾“å‡ºç»“æœ
      - name: éªŒè¯è¾“å‡ºç»“æœ
        run: |
          echo "ğŸ“Š éªŒè¯è¾“å‡ºæ–‡ä»¶ï¼š"
          if exist 4K_uhd_hb.txt (
            echo "âœ… 4K_uhd_hb.txt åˆ›å»ºæˆåŠŸ"
            echo "ğŸ“ æ–‡ä»¶å¤§å°ï¼š$(Get-Item 4K_uhd_hb.txt).Length / 1KB KB"
            echo "ğŸ“„ å‰15è¡Œå†…å®¹ï¼š"
            Get-Content 4K_uhd_hb.txt -TotalCount 15
          ) else (
            echo "âŒ 4K_uhd_hb.txt æœªåˆ›å»º"
            exit 1
          )
      
      # 7. æäº¤æ›´æ”¹
      - name: æäº¤æ›´æ”¹
        run: |
          echo "ğŸ“ å‡†å¤‡æäº¤æ›´æ”¹..."
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          
          # æ£€æŸ¥æ˜¯å¦æœ‰æ›´æ”¹
          git status
          
          if (git diff --quiet) {
            echo "âœ… æ²¡æœ‰æ–‡ä»¶éœ€è¦æ›´æ–°"
          } else {
            echo "ğŸ”„ å‘ç°éœ€è¦æ›´æ–°çš„æ–‡ä»¶"
            git add 4K_uhd_hb.txt
            git commit -m "ğŸš€ è‡ªåŠ¨æ›´æ–°4Kè¶…é«˜æ¸…ç›´æ’­æº ($(Get-Date -Format 'yyyy-MM-dd'))"
            
            # æ¨é€åˆ°GitHub
            git push origin HEAD:main
            echo "âœ… æ›´æ”¹å·²æäº¤åˆ°GitHub"
          }
        
      # 8. åˆ›å»ºPRï¼ˆå¯é€‰ï¼‰
      - name: åˆ›å»ºPRï¼ˆå¦‚æœæœ‰æ›´æ–°ï¼‰
        uses: peter-evans/create-pull-request@v5
        if: steps.commit.outputs.changes != 'false'
        with:
          title: 'ğŸš€ è‡ªåŠ¨æ›´æ–°4Kè¶…é«˜æ¸…ç›´æ’­æº'
          body: |
            ## è‡ªåŠ¨æ›´æ–°æŠ¥å‘Š
            
            - **æ›´æ–°æ—¶é—´**: ${{ github.event.head_commit.timestamp }}
            - **å·¥ä½œæµ**: ${{ github.workflow }}
            - **è§¦å‘æ–¹å¼**: ${{ github.event_name }}
            
            ### æ›´æ–°å†…å®¹
            - åˆå¹¶äº†4K_uhd_channels.txtä¸­çš„.m3uç›´æ’­æº
            - è½¬æ¢ä¸º4K_uhd_hb.txtæ ¼å¼
            - ä¿ç•™äº†é¢‘é“åç§°ä¸URLå¯¹åº”å…³ç³»
            - å»é™¤äº†é‡å¤çš„ç›´æ’­çº¿è·¯
            
            ### æ“ä½œæ—¥å¿—
            è¯·æŸ¥çœ‹å·¥ä½œæµæ—¥å¿—è·å–è¯¦ç»†ä¿¡æ¯ã€‚
          labels: 'automated-update,4k-channels'
          branch: 'auto-update-4k-channels'
          base: 'main'