name: ç”µè§†ç›´æ’­çº¿è·¯è‡ªåŠ¨æ›´æ–°å·¥ä½œæµï¼ˆåŸºäºGitHub APIï¼‰

on:
  schedule:
    - cron: '0 8 * * *'  # æ¯å¤©æ—©ä¸Š8ç‚¹è¿è¡Œ
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  update-tv-channels:
    runs-on: ubuntu-latest
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 1  # åªè·å–æœ€æ–°æäº¤ï¼Œå‡å°‘å¸¦å®½ä½¿ç”¨
          ref: ${{ github.ref }}
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: ç¯å¢ƒå‡†å¤‡
        run: |
          echo "å‡†å¤‡Pythonç¯å¢ƒå’Œä¾èµ–å®‰è£…"
          echo "å·¥ä½œç›®å½•: $(pwd)"
          ls -la
      
      - name: è®¾ç½®Pythonç¯å¢ƒ
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
          cache: 'pip'
      
      - name: å®‰è£…Pythonä¾èµ–
        run: |
          python -m pip install --upgrade pip
          pip install requests
          echo "å·²å®‰è£…ä¾èµ–: requests"
      
      - name: è¿è¡Œç”µè§†ç›´æ’­çº¿è·¯æ”¶é›†è„šæœ¬
        run: |
          echo "å¼€å§‹æ‰§è¡Œtvzydaily.pyè„šæœ¬..."
          python tvzydaily.py
          echo "è„šæœ¬æ‰§è¡Œå®Œæˆï¼Œæ£€æŸ¥è¾“å‡ºæ–‡ä»¶"
          if [ -f "tzydauto.txt" ]; then
            echo "è¾“å‡ºæ–‡ä»¶ç”ŸæˆæˆåŠŸ: $(wc -l tzydauto.txt) è¡Œ"
            head -10 tzydauto.txt
          else
            echo "é”™è¯¯: è¾“å‡ºæ–‡ä»¶æœªç”Ÿæˆ"
            exit 1
          fi
      
      - name: ç¡®ä¿APIæ›´æ–°è„šæœ¬å­˜åœ¨
        run: |
          if [ ! -f "github_api_updater.py" ]; then
            echo "é”™è¯¯: github_api_updater.py è„šæœ¬ä¸å­˜åœ¨"
            exit 1
          else
            echo "âœ… APIæ›´æ–°è„šæœ¬å­˜åœ¨"
            chmod +x github_api_updater.py
          fi
      
      - name: ç³»ç»Ÿå¥åº·æ£€æŸ¥
        run: |
          echo "ğŸ¥ ç³»ç»Ÿå¥åº·æ£€æŸ¥..."
          echo "ğŸ“Š å½“å‰æ—¶é—´: $(date)"
          echo "ğŸ“¡ ç½‘ç»œè¿æ¥æµ‹è¯•..."
          ping -c 2 api.github.com >/dev/null 2>&1 && echo "âœ… ç½‘ç»œè¿æ¥æ­£å¸¸" || echo "âš ï¸  ç½‘ç»œè¿æ¥æµ‹è¯•å¤±è´¥ï¼Œä½†å°†ç»§ç»­å°è¯•"
      
      - name: ä½¿ç”¨GitHub APIæ›´æ–°æ–‡ä»¶ï¼ˆæ— git pushç‰ˆæœ¬ï¼‰
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO_OWNER: ${{ github.repository_owner }}
          REPO_NAME: ${{ github.event.repository.name || 'zhby' }}
          BRANCH: ${{ github.ref_name }}
        run: |
          echo "ğŸš€ å¼€å§‹ä½¿ç”¨GitHub APIæ›´æ–°æ–‡ä»¶..."
          echo "ğŸ“‹ æ“ä½œè¯¦æƒ…:"
          echo "  - ç›®æ ‡æ–‡ä»¶: tzydauto.txt"
          echo "  - æ›´æ–°æ¨¡å¼: åŸºäºSHAçš„APIåŸå­æ“ä½œ"
          echo "  - é‡è¯•ç­–ç•¥: æ™ºèƒ½æŒ‡æ•°é€€é¿"
          echo "  - ä»“åº“ä¿¡æ¯: ${REPO_OWNER}/${REPO_NAME}"
          echo "  - ç›®æ ‡åˆ†æ”¯: ${BRANCH}"
          
          # è®¾ç½®ç¯å¢ƒå˜é‡ï¼Œé¿å…åœ¨æ—¥å¿—ä¸­æ˜¾ç¤ºtoken
          export PYTHONUNBUFFERED=1
          
          # è¿è¡ŒAPIæ›´æ–°è„šæœ¬
          python github_api_updater.py \
            --token "${GITHUB_TOKEN}" \
            --owner "${REPO_OWNER}" \
            --repo "${REPO_NAME}" \
            --file "tzydauto.txt" \
            --branch "${BRANCH}" \
            --message "è‡ªåŠ¨æ›´æ–°ç”µè§†ç›´æ’­çº¿è·¯ - $(date +'%Y-%m-%d %H:%M:%S')"
          
          # ä¿å­˜è„šæœ¬æ‰§è¡ŒçŠ¶æ€
          API_UPDATE_STATUS=$?
          echo "âœ… APIæ›´æ–°è„šæœ¬æ‰§è¡Œå®Œæˆï¼ŒçŠ¶æ€ç : ${API_UPDATE_STATUS}"
          
          # æ£€æŸ¥æ›´æ–°çŠ¶æ€
          if [ ${API_UPDATE_STATUS} -eq 0 ]; then
            echo "ğŸ‰ ğŸ‰ ğŸ‰ æ–‡ä»¶æ›´æ–°æˆåŠŸï¼"
            echo "âœ… åŸºäºGitHub APIçš„åŸå­æ›´æ–°æ–¹æ¡ˆæ‰§è¡ŒæˆåŠŸï¼"
            echo "ğŸ¯ ä¼˜åŠ¿: å®Œå…¨é¿å…Git Pushå†²çªï¼ŒåŸºäºSHAçš„ä¹è§‚å¹¶å‘æ§åˆ¶ç¡®ä¿æ•°æ®ä¸€è‡´æ€§"
          else
            echo "âŒ æ–‡ä»¶æ›´æ–°å¤±è´¥ï¼"
            echo "ğŸ” è¯·æ£€æŸ¥æ—¥å¿—è·å–è¯¦ç»†é”™è¯¯ä¿¡æ¯"
            exit ${API_UPDATE_STATUS}
          fi
      
      - name: åˆ›å»ºæ›´æ–°çŠ¶æ€æ ‡è®°æ–‡ä»¶
        if: success()
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO_OWNER: ${{ github.repository_owner }}
          REPO_NAME: ${{ github.event.repository.name || 'zhby' }}
          BRANCH: ${{ github.ref_name }}
        run: |
          echo "ğŸ”– åˆ›å»ºæ›´æ–°çŠ¶æ€æ ‡è®°æ–‡ä»¶..."
          echo "Last successful update: $(date)" > update_status.txt
          echo "Workflow run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}" >> update_status.txt
          echo "Commit SHA: ${{ github.sha }}" >> update_status.txt
          
          # ä½¿ç”¨APIæ›´æ–°çŠ¶æ€æ–‡ä»¶
          python github_api_updater.py \
            --token "${GITHUB_TOKEN}" \
            --owner "${REPO_OWNER}" \
            --repo "${REPO_NAME}" \
            --file "update_status.txt" \
            --branch "${BRANCH}" \
            --message "æ›´æ–°çŠ¶æ€æ ‡è®°æ–‡ä»¶ - $(date +'%Y-%m-%d %H:%M:%S')"
      
      - name: ä¸Šä¼ è°ƒè¯•æ—¥å¿—
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: github-api-logs
          path: |
            github_api_update.log
            tzydauto.txt
          retention-days: 7
      
      - name: æˆåŠŸé€šçŸ¥
        if: success()
        run: |
          echo "ğŸ‰ ğŸ‰ ğŸ‰ å·¥ä½œæµæ‰§è¡ŒæˆåŠŸï¼ğŸ‰ ğŸ‰ ğŸ‰"
          echo "âœ… æ–‡ä»¶ tzydauto.txt å·²æˆåŠŸæ›´æ–°åˆ°GitHubä»“åº“"
          echo "ğŸ”„ ä½¿ç”¨GitHub APIåŸå­æ›´æ–°æ–¹æ¡ˆï¼Œå®Œå…¨é¿å…Git Pushå†²çª"
          echo "ğŸ“Š åŸºäºSHAçš„ä¹è§‚å¹¶å‘æ§åˆ¶ç¡®ä¿æ•°æ®ä¸€è‡´æ€§"
          echo "ğŸ¯ å·¥ä½œæµè¿è¡ŒURL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
      
      - name: å¤±è´¥é€šçŸ¥
        if: failure()
        run: |
          echo "âŒ âŒ âŒ å·¥ä½œæµæ‰§è¡Œå¤±è´¥ï¼âŒ âŒ âŒ"
          echo "ğŸ” æ•…éšœæ’é™¤æ­¥éª¤:"
          echo "1. æ£€æŸ¥GitHub APIæƒé™å’Œtokenæœ‰æ•ˆæ€§"
          echo "2. éªŒè¯ä»“åº“å­˜åœ¨ä¸”åˆ†æ”¯æ­£ç¡®"
          echo "3. æ£€æŸ¥æ—¥å¿—ä¸­çš„å…·ä½“é”™è¯¯ä¿¡æ¯"
          echo "4. å°è¯•æ‰‹åŠ¨è¿è¡Œgithub_api_updater.pyè„šæœ¬è¿›è¡Œè°ƒè¯•"
          echo "5. ç¡®è®¤ç½‘ç»œè¿æ¥å’ŒAPIé€Ÿç‡é™åˆ¶"
          echo "ğŸ“Š å·¥ä½œæµè¿è¡ŒURL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          exit 1
