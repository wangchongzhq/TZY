name: ç”µè§†ç›´æ’­çº¿è·¯è‡ªåŠ¨æ›´æ–°

on:
  # å®šæ—¶è§¦å‘ - æ¯å¤©åŒ—äº¬æ—¶é—´æ—©ä¸Š3ç‚¹ï¼ˆUTCæ—¶é—´ä¸ºå‰ä¸€å¤©çš„19ç‚¹ï¼‰
  schedule:
    - cron: '0 19 * * *'
  # æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      update_reason:
        description: 'æ›´æ–°åŸå› ï¼ˆå¯é€‰ï¼‰'
        required: false
        default: 'æ‰‹åŠ¨è§¦å‘æ›´æ–°'

jobs:
  update-tv-lines:
    runs-on: ubuntu-latest
    steps:
      - name: æ£€å‡ºä»£ç ä»“åº“
        uses: actions/checkout@v3
      
      - name: è®¾ç½®Pythonç¯å¢ƒ
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'
          cache: 'pip'
      
      - name: å®‰è£…ä¾èµ–
        run: |
          python -m pip install --upgrade pip
          pip install requests
      
      - name: è¿è¡Œæ›´æ–°è„šæœ¬
        run: |
          chmod +x ./tvzy.py
          python ./tvzy.py
      
      - name: æ£€æŸ¥æ˜¯å¦ç”Ÿæˆäº†è¾“å‡ºæ–‡ä»¶
        id: check_file
        run: |
          if [ -f ./tzydauto.txt ]; then
            echo "file_exists=true" >> $GITHUB_OUTPUT
            echo "æ–‡ä»¶å¤§å°: $(ls -lh ./tzydauto.txt)"
          else
            echo "file_exists=false" >> $GITHUB_OUTPUT
          fi
      
      - name: æäº¤å’Œæ¨é€æ›´æ–°
        if: steps.check_file.outputs.file_exists == 'true'
        run: |
          git config --global user.name 'GitHub Actions Bot'
          git config --global user.email 'github-actions@github.com'
          git add ./tzydauto.txt
          git add ./tvzy.log || true  # æ—¥å¿—æ–‡ä»¶å¯é€‰
          
          # æ£€æŸ¥æ˜¯å¦æœ‰æ›´æ”¹
          if git diff --staged --quiet; then
            echo "æ²¡æœ‰å‘ç°æ›´æ”¹ï¼Œè·³è¿‡æäº¤"
          else
            # è·å–å½“å‰æ—¥æœŸï¼ˆåŒ—äº¬æ—¶é—´ï¼‰
            TODAY=$(TZ='Asia/Shanghai' date +'%Y-%m-%d')
            # ä½¿ç”¨æ‰‹åŠ¨è§¦å‘çš„åŸå› æˆ–é»˜è®¤æ¶ˆæ¯
            REASON="${{ github.event.inputs.update_reason || 'è‡ªåŠ¨æ›´æ–° '${TODAY}' ç”µè§†ç›´æ’­çº¿è·¯' }}"
            git commit -m "${REASON}"
            git push
            echo "æ›´æ–°å·²æäº¤å¹¶æ¨é€"
          fi
      
      - name: è¾“å‡ºæˆåŠŸæ¶ˆæ¯
        if: steps.check_file.outputs.file_exists == 'true'
        run: |
          echo "ğŸ‰ ç”µè§†ç›´æ’­çº¿è·¯æ›´æ–°å®Œæˆï¼"
          echo "ğŸ“ ç”Ÿæˆçš„æ–‡ä»¶: tzydauto.txt"
          echo "ğŸ“Š æ–‡ä»¶ç»Ÿè®¡ä¿¡æ¯å·²è®°å½•åˆ°æ—¥å¿—"
      
      - name: è¾“å‡ºå¤±è´¥æ¶ˆæ¯
        if: steps.check_file.outputs.file_exists == 'false'
        run: |
          echo "âŒ æ›´æ–°å¤±è´¥ï¼šæœªç”Ÿæˆè¾“å‡ºæ–‡ä»¶"
          exit 1
      
      - name: ä¸Šä¼ è¾“å‡ºæ–‡ä»¶ä½œä¸ºæ„å»ºäº§ç‰©
        if: steps.check_file.outputs.file_exists == 'true'
        uses: actions/upload-artifact@v3
        with:
          name: tv-live-channels
          path: ./tzydauto.txt
          retention-days: 7  # ä¿å­˜7å¤©
          if-no-files-found: error
