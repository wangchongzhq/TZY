name: ç”µè§†ç›´æ’­çº¿è·¯è‡ªåŠ¨æ›´æ–°

on:
  # å®šæ—¶è§¦å‘ - æ¯å¤©åŒ—äº¬æ—¶é—´æ—©ä¸Š3ç‚¹ï¼ˆUTCæ—¶é—´ä¸ºå‰ä¸€å¤©çš„19ç‚¹ï¼‰
  schedule:
    - cron: '0 19 * * *'
  # æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      update_reason:
        description: 'æ›´æ–°åŸå› ï¼ˆå¯é€‰ï¼‰'
        required: false
        default: 'æ‰‹åŠ¨è§¦å‘æ›´æ–°'

jobs:
  update-tv-lines:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: æ£€å‡ºä»£ç ä»“åº“
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: true
      
      - name: è®¾ç½®Pythonç¯å¢ƒ
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'
          cache: 'pip'
      
      - name: å®‰è£…ä¾èµ–
        run: |
          python -m pip install --upgrade pip
          pip install requests
      
      - name: è¿è¡Œæ›´æ–°è„šæœ¬
        run: |
          chmod +x ./tvzy.py
          python ./tvzy.py
      
      - name: æ£€æŸ¥æ˜¯å¦ç”Ÿæˆäº†è¾“å‡ºæ–‡ä»¶
        id: check_file
        run: |
          if [ -f ./tzydauto.txt ]; then
            echo "file_exists=true" >> $GITHUB_OUTPUT
            echo "æ–‡ä»¶å¤§å°: $(du -h ./tzydauto.txt | cut -f1)" >> $GITHUB_STEP_SUMMARY
            echo "é¢‘é“æ•°é‡: $(grep -v '^#' ./tzydauto.txt | grep ',' | wc -l)" >> $GITHUB_STEP_SUMMARY
          else
            echo "file_exists=false" >> $GITHUB_OUTPUT
            echo "::error::è¾“å‡ºæ–‡ä»¶tzydauto.txtæœªç”Ÿæˆï¼" >> $GITHUB_STEP_SUMMARY
          fi
          
          # è®°å½•ç›´æ’­æºURLæ•°é‡
          LIVE_SOURCES_COUNT=$(grep -o '"https://' ./tvzy.py | wc -l)
          echo "ç›´æ’­æºURLæ•°é‡: $LIVE_SOURCES_COUNT" >> $GITHUB_STEP_SUMMARY
      
      - name: æäº¤å’Œæ¨é€æ›´æ–°
        if: steps.check_file.outputs.file_exists == 'true'
        run: |
          # é…ç½®gitèº«ä»½å’Œè¡Œä¸º
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "GitHub Actions Bot"
          git config --global pull.rebase false  # ä½¿ç”¨mergeè€Œä¸æ˜¯rebase
          git config --global core.autocrlf false  # é˜²æ­¢è¡Œå°¾å­—ç¬¦è½¬æ¢é—®é¢˜
          
          echo "=== å¼€å§‹Gitæ“ä½œ ==="
          echo "å½“å‰åˆ†æ”¯: $(git branch --show-current)"
          
          # ç›´æ¥ä½¿ç”¨originè¿œç¨‹ä»“åº“
          echo "åŒæ­¥æœ¬åœ°ä¸è¿œç¨‹ä»“åº“..."
          git remote -v
          git fetch origin ${{ github.ref_name }}
          git checkout ${{ github.ref_name }} || git checkout -b ${{ github.ref_name }}
          git reset --hard origin/${{ github.ref_name }}
          
          echo "æœ¬åœ°ä»“åº“å·²é‡ç½®ä¸ºè¿œç¨‹æœ€æ–°çŠ¶æ€"
          
          # é‡æ–°æ‰§è¡Œè„šæœ¬ç¡®ä¿ç”Ÿæˆæœ€æ–°æ–‡ä»¶
          echo "é‡æ–°æ‰§è¡Œè„šæœ¬ç”Ÿæˆæœ€æ–°æ–‡ä»¶..."
          python ./tvzy.py || {
            echo "è„šæœ¬æ‰§è¡Œå¤±è´¥ï¼Œä½¿ç”¨ç°æœ‰æ–‡ä»¶ç»§ç»­"
          }
          
          # æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨
          if [ ! -f "./tzydauto.txt" ]; then
            echo "::error::é”™è¯¯ï¼štzydauto.txtæ–‡ä»¶æœªç”Ÿæˆ"
            exit 1
          fi
          
          # æ·»åŠ æ–‡ä»¶
          echo "æ·»åŠ æ›´æ”¹çš„æ–‡ä»¶..."
          git add ./tzydauto.txt
          git add ./tvzy.log || true  # æ—¥å¿—æ–‡ä»¶å¯é€‰
          
          # æ£€æŸ¥æ˜¯å¦æœ‰æ›´æ”¹
          if git diff --staged --quiet; then
            echo "æ²¡æœ‰æ£€æµ‹åˆ°æ›´æ”¹ï¼Œè·³è¿‡æäº¤"
            exit 0
          fi
          
          # è·å–å½“å‰æ—¥æœŸï¼ˆåŒ—äº¬æ—¶é—´ï¼‰
          TODAY=$(TZ='Asia/Shanghai' date +'%Y-%m-%d')
          # ä½¿ç”¨æ‰‹åŠ¨è§¦å‘çš„åŸå› æˆ–é»˜è®¤æ¶ˆæ¯
          if [ -n "${{ github.event.inputs.update_reason }}" ]; then
            REASON="${{ github.event.inputs.update_reason }}"
          else
            REASON="è‡ªåŠ¨æ›´æ–° ${TODAY} ç”µè§†ç›´æ’­çº¿è·¯"
          fi
          
          # æäº¤æ›´æ”¹
          echo "æäº¤æ›´æ”¹..."
          git commit -m "${REASON}"
          
          # æ¨é€æ›´æ”¹
          echo "å°è¯•æ¨é€æ›´æ”¹åˆ°è¿œç¨‹ä»“åº“..."
          # ç›´æ¥æ¨é€åˆ°origin
          git push origin ${{ github.ref_name }} || {
            echo "æ¨é€å¤±è´¥ï¼Œå°è¯•ä½¿ç”¨--force-with-leaseæ¨é€..."
            git push --force-with-lease origin ${{ github.ref_name }} || {
              echo "--force-with-leaseæ¨é€å¤±è´¥ï¼Œæœ€åå°è¯•ä½¿ç”¨--forceæ¨é€..."
              git push --force origin ${{ github.ref_name }} || {
                echo "::error::æ‰€æœ‰æ¨é€æ–¹å¼å‡å¤±è´¥ï¼Œè¯·æ£€æŸ¥GitHubæƒé™é…ç½®"
                exit 1
              }
            }
          }
          
          echo "æ›´æ–°å·²æäº¤å¹¶æ¨é€"
      
      - name: è¾“å‡ºæˆåŠŸæ¶ˆæ¯
        if: steps.check_file.outputs.file_exists == 'true'
        run: |
          echo "ğŸ‰ ç”µè§†ç›´æ’­çº¿è·¯æ›´æ–°å®Œæˆï¼"
          echo "ğŸ“ ç”Ÿæˆçš„æ–‡ä»¶: tzydauto.txt"
          echo "ğŸ“Š æ–‡ä»¶ç»Ÿè®¡ä¿¡æ¯å·²è®°å½•åˆ°æ—¥å¿—"
      
      - name: è¾“å‡ºå¤±è´¥æ¶ˆæ¯
        if: steps.check_file.outputs.file_exists == 'false'
        run: |
          echo "âŒ æ›´æ–°å¤±è´¥ï¼šæœªç”Ÿæˆè¾“å‡ºæ–‡ä»¶"
          exit 1
      
      - name: ä¿å­˜è¾“å‡ºæ–‡ä»¶ä½œä¸ºæ„å»ºäº§ç‰©
        if: steps.check_file.outputs.file_exists == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: tv-channels-list
          path: ./tzydauto.txt
          retention-days: 7  # ä¿å­˜7å¤©
          if-no-files-found: error
