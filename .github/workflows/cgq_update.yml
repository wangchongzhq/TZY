name: 更新超高清直播源

on:
  # 手动触发
  workflow_dispatch:
    inputs:
      force-update:
        description: '强制更新直播源'
        required: false
        default: 'false'
        type: boolean
  
  # 定时触发 - 每天北京时间早上3点（UTC时间前一天19点）
  schedule:
    - cron: '0 19 * * *'

env:
  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

permissions:
  contents: write  # 允许工作流写入仓库内容
  actions: read    # 允许读取工作流信息

jobs:
  update-live-sources:
    runs-on: ubuntu-latest
      
    steps:
      # 检出代码
      - name: 检出代码
        uses: actions/checkout@v3
        with:
          fetch-depth: 0  # 获取完整历史
          persist-credentials: true  # 保存凭证用于推送
          ref: main  # 明确指定分支
      
      # 设置Python环境
      - name: 设置Python环境
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
          cache: 'pip'  # 缓存pip依赖
      
      # 安装依赖
      - name: 安装依赖
        run: |
          python -m pip install --upgrade pip
          pip install requests
      
      # 确保脚本可执行
      - name: 赋予脚本执行权限
        run: chmod +x get_cgq_sources.py
      
      # 执行脚本获取直播源
      - name: 执行脚本获取直播源
        run: python get_cgq_sources.py
      
      # 检查输出文件是否生成
      - name: 检查输出文件
        id: check_file
        run: |
          if [ -f "CGQ.TXT" ]; then
            echo "file_exists=true" >> $GITHUB_OUTPUT
            echo "文件大小: $(du -h CGQ.TXT | cut -f1)" >> $GITHUB_STEP_SUMMARY
            echo "频道数量: $(grep -v '^#' CGQ.TXT | grep ',' | wc -l)" >> $GITHUB_STEP_SUMMARY
          else
            echo "file_exists=false" >> $GITHUB_OUTPUT
            echo "::error::输出文件CGQ.TXT未生成！" >> $GITHUB_STEP_SUMMARY
          fi
      
      # 提交和推送更改
      - name: 提交和推送更改
        if: steps.check_file.outputs.file_exists == 'true'
        run: |
          # 配置git身份和行为
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git config --global pull.rebase false  # 使用merge而不是rebase
          git config --global core.autocrlf false  # 防止行尾字符转换问题
          
          echo "=== 开始Git操作 ==="
          echo "当前分支: $(git branch --show-current)"
          
          # 获取远程最新更改
          echo "获取远程最新更改..."
          git fetch origin main
          
          # 检查是否有冲突（远程有本地没有的提交）
          LOCAL_COMMITS=$(git rev-list --count HEAD ^origin/main)
          REMOTE_COMMITS=$(git rev-list --count origin/main ^HEAD)
          
          echo "本地有 $LOCAL_COMMITS 个远程没有的提交"
          echo "远程有 $REMOTE_COMMITS 个本地没有的提交"
          
          # 如果远程有本地没有的提交，尝试合并
          if [ $REMOTE_COMMITS -gt 0 ]; then
            echo "检测到远程有新的提交，尝试合并..."
            # 使用--allow-unrelated-histories处理可能的历史不匹配问题
            git merge --allow-unrelated-histories --strategy-option=theirs origin/main || {
              echo "合并失败，使用强制更新策略..."
              # 保存我们的更改
              git stash
              # 重置到远程最新状态
              git reset --hard origin/main
              # 应用我们的更改
              git stash pop || echo "无更改需要应用"
            }
          fi
          
          # 重新执行脚本确保生成最新文件
          echo "重新执行脚本生成最新直播源..."
          python get_cgq_sources.py
          
          # 检查文件是否存在
          if [ ! -f "CGQ.TXT" ]; then
            echo "::error::错误：CGQ.TXT文件未生成"
            exit 1
          fi
          
          # 添加文件
          echo "添加更改的文件..."
          git add CGQ.TXT get_cgq_sources.log
          
          # 检查是否有更改
          if git diff --staged --quiet; then
            echo "没有检测到更改，跳过提交"
            exit 0
          fi
          
          # 提交更改
          echo "提交更改..."
          git commit -m "Auto-update IPTV files - $(date '+%Y-%m-%d %H:%M:%S')"
          
          # 推送到远程仓库
          echo "尝试正常推送到远程仓库..."
          git push origin main || {
            echo "正常推送失败，使用强制推送..."
            # 使用强制推送，但保留merge commit历史
            git push --force-with-lease origin main || {
              echo "强制推送也失败，使用最激进的强制推送..."
              git push --force origin main
            }
          }
          
          if [ $? -eq 0 ]; then
            echo "成功推送到远程仓库"
          else
            echo "::error::推送失败，请检查GitHub权限配置"
            exit 1
          fi
      
      # 保存输出文件作为构建产物
      - name: 保存输出文件
        if: steps.check_file.outputs.file_exists == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: cgq-live-sources
          path: |
            CGQ.TXT
            get_cgq_sources.log
          retention-days: 7  # 保存7天
          if-no-files-found: error  # 文件不存在时报错
      
      # 生成构建摘要
      - name: 生成构建摘要
        if: steps.check_file.outputs.file_exists == 'true'
        run: |
          echo "## 超高清直播源更新摘要" >> $GITHUB_STEP_SUMMARY
          echo "- 执行时间: $(date '+%Y-%m-%d %H:%M:%S')" >> $GITHUB_STEP_SUMMARY
          echo "- 输出文件: CGQ.TXT" >> $GITHUB_STEP_SUMMARY
          echo "- 文件大小: $(du -h CGQ.TXT | cut -f1)" >> $GITHUB_STEP_SUMMARY
          echo "- 频道数量: $(grep -v '^#' CGQ.TXT | grep ',' | wc -l)" >> $GITHUB_STEP_SUMMARY
          echo "- 更新日志: 可在构建产物中查看get_cgq_sources.log文件" >> $GITHUB_STEP_SUMMARY
