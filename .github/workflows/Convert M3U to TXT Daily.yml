name: Convert M3U to TXT Daily

on:
  schedule:
    - cron: '0 2 * * *'  # 每天UTC时间2:00运行（北京时间10:00）
  workflow_dispatch:      # 允许手动触发
  push:
    paths:
      - 'ipvym3a'
      - 'ipzy.m3u'
      - 'iptv.m3a'
      - 'convert_m3u_to_txt.py'

jobs:
  convert:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        repository: wangchongzhq/TZY

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip

    - name: Convert M3U to TXT
      run: |
        echo "开始转换M3U文件..."
        python convert_m3u_to_txt.py
        echo "=== 转换完成 ==="
        echo "生成的文件:"
        ls -la *.txt
        echo "=== 文件内容统计 ==="
        wc -l ipzy.txt || echo "无法统计行数"
        echo "=== 前20行预览 ==="
        head -n 20 ipzy.txt || echo "无法预览文件"

    - name: Commit and push if changed
      run: |
        # 配置git身份和行为
        git config --local user.email "github-actions[bot]@users.noreply.github.com"
        git config --local user.name "GitHub Actions Bot"
        git config --global pull.rebase false  # 使用merge而不是rebase
        git config --global core.autocrlf false  # 防止行尾字符转换问题
        
        echo "=== 开始Git操作 ==="
        echo "当前分支: $(git branch --show-current)"
        
        # 配置TZY远程仓库（使用与origin相同的URL）
        echo "配置TZY远程仓库..."
        git remote -v
        git remote add TZY $(git remote get-url origin) || echo "TZY远程仓库已存在"
        git remote -v
        
        # 强制确保本地分支与远程同步
        echo "强制同步本地与远程仓库..."
        git fetch TZY ${{ github.ref_name }} || {
          echo "fetch TZY失败，尝试使用origin..."
          git fetch origin ${{ github.ref_name }}
        }
        git checkout ${{ github.ref_name }} || git checkout -b ${{ github.ref_name }}
        git reset --hard TZY/${{ github.ref_name }} || {
          echo "reset TZY失败，尝试使用origin..."
          git reset --hard origin/${{ github.ref_name }}
        }
        
        echo "本地仓库已重置为远程最新状态"
        
        # 添加文件
        echo "添加更改的文件..."
        git add *.txt
        
        # 检查是否有更改
        if git diff --staged --quiet; then
          echo "没有检测到更改，跳过提交"
          exit 0
        fi
        
        # 提交更改
        echo "提交更改..."
        git commit -m "Auto-convert M3U files to TXT - $(date '+%Y-%m-%d %H:%M:%S')"
        
        # 推送到远程仓库
        echo "尝试推送更改到远程仓库..."
        git push TZY ${{ github.ref_name }} || {
          echo "推送TZY失败，尝试使用origin..."
          git push origin ${{ github.ref_name }} || {
            echo "推送origin失败，尝试使用--force-with-lease推送..."
            git push --force-with-lease TZY ${{ github.ref_name }} || {
              echo "--force-with-lease TZY推送失败，尝试使用--force-with-lease origin..."
              git push --force-with-lease origin ${{ github.ref_name }} || {
                echo "--force-with-lease origin推送失败，最后尝试使用--force TZY推送..."
                git push --force TZY ${{ github.ref_name }} || {
                  echo "--force TZY推送失败，最后尝试使用--force origin推送..."
                  git push --force origin ${{ github.ref_name }} || {
                    echo "::error::所有推送方式均失败，请检查GitHub权限配置"
                    exit 1
                  }
                }
              }
            }
          }
        }
